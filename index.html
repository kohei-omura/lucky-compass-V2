<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”® Lucky Compass â€” å…¨å è¡“çµ±åˆ é–‹é‹ãƒŠãƒ“</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;700;900&family=Zen+Old+Mincho:wght@400;700;900&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --gold:#C9A84C; --gold-light:#F0D080; --gold-dark:#8A6A1A;
  --deep:#07040F; --purple:#14082A; --violet:#2D1B5E;
  --accent:#8B5CF6; --rose:#FF6B9D; --cyan:#4DC8E0;
  --green:#50C878; --text:#F0E6FF; --muted:#9A8AB0;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Serif JP',serif;background:var(--deep);color:var(--text);min-height:100vh;overflow-x:hidden}

/* â”€â”€ Starfield â”€â”€ */
.starfield{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.star{position:absolute;border-radius:50%;background:#fff;animation:twinkle var(--dur,3s) infinite var(--delay,0s)}
@keyframes twinkle{0%,100%{opacity:.15;transform:scale(1)}50%{opacity:1;transform:scale(1.6)}}
.shoot{position:absolute;width:130px;height:1px;background:linear-gradient(90deg,transparent,#fff,transparent);animation:shoot var(--sd,5s) linear infinite var(--ss,0s);opacity:0}
@keyframes shoot{0%{transform:translateX(-200px) translateY(0) rotate(-30deg);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateX(calc(100vw + 200px)) translateY(200px) rotate(-30deg);opacity:0}}

/* â”€â”€ Layout â”€â”€ */
.wrap{position:relative;z-index:1;max-width:500px;margin:0 auto;padding:20px 16px 80px}

/* â”€â”€ Header â”€â”€ */
header{text-align:center;padding:36px 0 22px}
.hdr-sym{font-size:3rem;display:block;margin-bottom:8px;animation:float 3s ease-in-out infinite;filter:drop-shadow(0 0 18px rgba(201,168,76,.6))}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
h1{font-family:'Cinzel',serif;font-size:1.9rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--gold-light),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:.12em;margin-bottom:5px}
.subtitle{font-size:.7rem;color:var(--muted);letter-spacing:.2em}

/* â”€â”€ Info bar â”€â”€ */
.info-bar{display:flex;gap:8px;margin:16px 0 12px}
.info-chip{flex:1;background:rgba(255,255,255,.04);border:1px solid rgba(201,168,76,.2);border-radius:12px;padding:9px 8px;text-align:center}
.ic-label{color:var(--gold);font-size:.6rem;letter-spacing:.1em;margin-bottom:2px}
.ic-val{color:var(--text);font-weight:700;font-size:.76rem}

/* â”€â”€ Tabs â”€â”€ */
.tab-nav{display:flex;gap:5px;margin:14px 0;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.tab-nav::-webkit-scrollbar{display:none}
.tb{flex-shrink:0;padding:8px 13px;background:rgba(255,255,255,.04);border:1px solid rgba(201,168,76,.15);border-radius:20px;color:var(--muted);font-size:.72rem;font-family:'Noto Serif JP',serif;cursor:pointer;transition:all .2s;white-space:nowrap}
.tb.active,.tb:hover{background:rgba(201,168,76,.15);border-color:var(--gold);color:var(--gold-light)}
.tc{display:none}.tc.active{display:block;animation:fiu .45s ease}
@keyframes fiu{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ Settings card â”€â”€ */
.scard{background:rgba(255,255,255,.03);border:1px solid rgba(201,168,76,.14);border-radius:18px;padding:18px;margin:12px 0}
.sc-title{font-size:.7rem;color:var(--gold);letter-spacing:.15em;margin-bottom:14px;text-align:center}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:9px}
.fg{display:flex;flex-direction:column;gap:4px}
.fg.full{grid-column:1/-1}
label{font-size:.66rem;color:var(--muted);letter-spacing:.07em}
select,input{background:rgba(255,255,255,.06);border:1px solid rgba(201,168,76,.22);border-radius:10px;color:var(--text);padding:8px 10px;font-size:.76rem;font-family:'Noto Serif JP',serif;width:100%;appearance:none}
select:focus,input:focus{outline:none;border-color:var(--gold)}
option{background:#1A0A2E}

/* â”€â”€ Buttons â”€â”€ */
.main-btn{width:100%;padding:15px;border:none;border-radius:14px;color:#fff;font-size:.92rem;font-family:'Zen Old Mincho',serif;font-weight:700;letter-spacing:.1em;cursor:pointer;margin:12px 0;background:linear-gradient(135deg,#7C3AED,#C9A84C,#7C3AED);background-size:200% 200%;animation:gshift 3s ease infinite;position:relative;overflow:hidden;transition:transform .1s}
@keyframes gshift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.main-btn::after{content:'';position:absolute;inset:0;background:linear-gradient(rgba(255,255,255,.1),transparent);pointer-events:none}
.main-btn:active{transform:scale(.98)}
.loc-btn{width:100%;padding:12px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.3);border-radius:12px;color:var(--gold);font-size:.8rem;font-family:'Noto Serif JP',serif;cursor:pointer;margin-bottom:10px;transition:all .2s}
.loc-btn:hover{background:rgba(201,168,76,.2)}
.loc-btn.ok{border-color:rgba(100,255,150,.4);color:#80FFB0;background:rgba(100,255,150,.05)}

/* â”€â”€ Cards â”€â”€ */
.rc{border-radius:18px;padding:20px;margin:12px 0;position:relative;overflow:hidden}
.rc::before{content:'';position:absolute;inset:0;border-radius:18px;padding:1px;background:linear-gradient(135deg,var(--gold),transparent,var(--accent));-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
.c-time{background:linear-gradient(135deg,rgba(201,168,76,.1),rgba(7,4,15,.8))}
.c-place{background:linear-gradient(135deg,rgba(139,92,246,.12),rgba(7,4,15,.8))}
.c-food{background:linear-gradient(135deg,rgba(255,107,157,.1),rgba(7,4,15,.8))}
.c-div{background:linear-gradient(135deg,rgba(45,27,94,.5),rgba(7,4,15,.8))}
.c-gacha{background:linear-gradient(135deg,rgba(77,200,224,.1),rgba(7,4,15,.8))}
.c-daily{background:linear-gradient(135deg,rgba(80,200,120,.1),rgba(7,4,15,.8))}
.c-cal{background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(7,4,15,.9))}
.c-msg{background:linear-gradient(135deg,rgba(201,168,76,.07),rgba(139,92,246,.07));border:1px solid rgba(201,168,76,.22);border-radius:14px;padding:16px;margin-bottom:12px;font-size:.85rem;line-height:1.85}

.ch{display:flex;align-items:center;gap:11px;margin-bottom:14px}
.ci{font-size:1.5rem;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.05);border-radius:11px;flex-shrink:0}
.ct{font-family:'Zen Old Mincho',serif;font-size:.96rem;color:var(--gold);letter-spacing:.1em}
.cs{font-size:.66rem;color:var(--muted);margin-top:1px}

/* â”€â”€ Time grid â”€â”€ */
.tgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.titem{background:rgba(255,255,255,.04);border-radius:11px;padding:10px;text-align:center}
.trange{font-size:.85rem;font-weight:700;color:var(--gold);margin-bottom:3px}
.tscore{font-size:1.35rem;font-weight:900;margin:3px 0}
.tlabel{font-size:.66rem;color:var(--muted)}

/* â”€â”€ Place / Food â”€â”€ */
.pi{background:rgba(255,255,255,.04);border-radius:13px;padding:13px;margin-bottom:8px;border-left:3px solid var(--accent)}
.pr{font-size:.6rem;color:var(--accent);letter-spacing:.1em;margin-bottom:3px}
.pn{font-size:.92rem;font-weight:700;margin-bottom:2px}
.ps{font-size:.75rem;color:var(--gold);margin-bottom:2px}
.pd{font-size:.72rem;color:var(--muted);line-height:1.6}
.fi{background:rgba(255,255,255,.04);border-radius:13px;padding:13px;margin-bottom:8px;border-left:3px solid var(--rose)}
.fr2{font-size:.6rem;color:var(--rose);letter-spacing:.1em;margin-bottom:3px}

/* â”€â”€ Divination â”€â”€ */
.di{padding:10px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.di:last-child{border-bottom:none}
.dn{font-size:.66rem;color:var(--gold);letter-spacing:.1em;margin-bottom:3px}
.dt{font-size:.76rem;line-height:1.7}

/* â”€â”€ Gacha â”€â”€ */
.gi{background:rgba(255,255,255,.04);border-radius:13px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:11px;border-left:3px solid var(--cyan)}
.gi.t1{border-left-color:#FFD700;background:rgba(255,215,0,.06)}
.gi.t2{border-left-color:#C0C0C0}
.gi.t3{border-left-color:#CD7F32}
.grb{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:.75rem;font-weight:700;flex-shrink:0}
.b1{background:linear-gradient(135deg,#FFD700,#B8860B);color:#000}
.b2{background:linear-gradient(135deg,#C0C0C0,#808080);color:#000}
.b3{background:linear-gradient(135deg,#CD7F32,#8B4513);color:#fff}
.bn{background:rgba(77,200,224,.2);color:var(--cyan)}
.ginfo{flex:1}
.gname{font-size:.88rem;font-weight:700;margin-bottom:2px}
.greason{font-size:.68rem;color:var(--muted);line-height:1.5}
.gpull{font-size:.68rem;padding:3px 9px;border-radius:20px;background:rgba(77,200,224,.15);color:var(--cyan);border:1px solid rgba(77,200,224,.3);white-space:nowrap;flex-shrink:0}
.gpull.rec{background:rgba(255,215,0,.15);color:#FFD700;border-color:rgba(255,215,0,.4)}
.gpull.ng{background:rgba(255,100,100,.1);color:#FF8080;border-color:rgba(255,100,100,.3)}

/* â”€â”€ Daily â”€â”€ */
.ditem{background:rgba(255,255,255,.04);border-radius:13px;padding:13px;margin-bottom:9px;display:flex;align-items:flex-start;gap:11px}
.demoji{font-size:1.9rem;flex-shrink:0}
.dlabel{font-size:.6rem;color:var(--gold);letter-spacing:.1em;margin-bottom:2px}
.dtitle{font-size:.9rem;font-weight:700;margin-bottom:2px}
.dsub{font-size:.7rem;color:var(--muted);margin-bottom:3px}
.dreason{font-size:.7rem;color:var(--cyan);line-height:1.6}

/* â”€â”€ Calendar â”€â”€ */
.cal-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:13px}
.cal-nav{background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.3);border-radius:8px;padding:5px 12px;color:var(--gold);cursor:pointer;font-size:.78rem}
.cal-title{font-family:'Cinzel',serif;font-size:.95rem;color:var(--gold-light)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.cdh{text-align:center;font-size:.6rem;color:var(--muted);padding:3px 0}
.cd{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:8px;font-size:.7rem;cursor:pointer;transition:all .2s;position:relative}
.cd.today{border:1px solid var(--gold);color:var(--gold-light);font-weight:700}
.cd.l5{background:rgba(255,215,0,.28);color:#FFD700;font-weight:900}
.cd.l4{background:rgba(201,168,76,.2);color:var(--gold-light);font-weight:700}
.cd.l3{background:rgba(139,92,246,.15);color:#C4B5FD}
.cd.l2{background:rgba(255,255,255,.04);color:var(--text)}
.cd.l1{background:rgba(255,100,100,.08);color:#FF9090}
.cd.om{opacity:.22}
.cd-star{font-size:.48rem;position:absolute;top:1px;right:2px}
.cal-legend{display:flex;gap:9px;flex-wrap:wrap;margin-top:11px}
.cl-item{display:flex;align-items:center;gap:4px;font-size:.6rem;color:var(--muted)}
.cl-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.cal-detail{background:rgba(255,255,255,.04);border-radius:12px;padding:13px;margin-top:10px;font-size:.78rem;line-height:1.7;border:1px solid rgba(201,168,76,.15);display:none}
.cal-detail.show{display:block;animation:fiu .4s ease}

/* â”€â”€ Score ring â”€â”€ */
.score-wrap{text-align:center;padding:4px 0 16px}
.score-ring{width:130px;height:130px;margin:0 auto 14px;position:relative}
.score-ring svg{width:100%;height:100%;transform:rotate(-90deg)}
.score-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.score-num{font-family:'Cinzel',serif;font-size:2.1rem;font-weight:700;color:var(--gold-light);line-height:1}
.score-lbl{font-size:.62rem;color:var(--muted);letter-spacing:.15em;margin-top:2px}
.verdict{font-family:'Zen Old Mincho',serif;font-size:1.1rem;color:var(--gold-light);margin-bottom:8px;letter-spacing:.1em}

/* â”€â”€ Lucky items grid â”€â”€ */
.li-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
.li-item{background:rgba(255,255,255,.04);border-radius:11px;padding:11px;display:flex;align-items:center;gap:9px}
.li-icon{font-size:1.4rem;flex-shrink:0}
.li-cat{font-size:.58rem;color:var(--muted);letter-spacing:.08em}
.li-name{font-size:.82rem;color:var(--text)}
.color-row{display:flex;gap:7px;flex-wrap:wrap;margin-top:10px}
.cdot{width:30px;height:30px;border-radius:50%;border:2px solid rgba(255,255,255,.18);cursor:pointer;transition:transform .2s;position:relative}
.cdot:hover{transform:scale(1.2)}

/* â”€â”€ Error â”€â”€ */
.err{background:rgba(255,100,100,.1);border:1px solid rgba(255,100,100,.3);border-radius:12px;padding:12px;text-align:center;color:#FF8080;font-size:.8rem;margin:10px 0;display:none}
.err.show{display:block}

/* â”€â”€ Game selector â”€â”€ */
#game-selector{display:flex;flex-wrap:wrap;gap:5px}

/* â”€â”€ Progress bars â”€â”€ */
.pbar-wrap{margin-bottom:12px}
.pbar-hdr{display:flex;justify-content:space-between;margin-bottom:4px}
.pbar-name{font-size:.76rem;color:var(--text)}
.pbar-score{font-family:'Cinzel',serif;font-size:.76rem;color:var(--gold-light)}
.pbar{height:7px;background:rgba(255,255,255,.08);border-radius:4px;overflow:hidden}
.pbar-fill{height:100%;border-radius:4px;background:linear-gradient(to right,var(--violet),var(--gold));transition:width 1.2s ease}

/* â”€â”€ Scrollbar â”€â”€ */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--deep)}
::-webkit-scrollbar-thumb{background:var(--violet);border-radius:4px}
footer{text-align:center;padding:22px 0 12px;color:var(--muted);font-size:.66rem;letter-spacing:.1em}
</style>
</head>
<body>
<div class="starfield" id="sf"></div>
<div class="wrap">

<header>
  <span class="hdr-sym">ğŸ”®</span>
  <h1>Lucky Compass</h1>
  <p class="subtitle">å…¨15ç¨®å è¡“çµ±åˆ âœ¦ é–‹é‹ãƒŠãƒ“ âœ¦ ç„¡æ–™</p>
</header>

<div class="info-bar">
  <div class="info-chip"><div class="ic-label">ğŸ“… æ—¥æ™‚</div><div class="ic-val" id="dt">--</div></div>
  <div class="info-chip"><div class="ic-label">ğŸŒ™ å…­æ›œ</div><div class="ic-val" id="ry">--</div></div>
  <div class="info-chip"><div class="ic-label">ğŸ“ ä½ç½®</div><div class="ic-val" id="loc">æœªå–å¾—</div></div>
</div>

<div class="tab-nav">
  <button class="tb active" onclick="switchTab('fortune',this)">ğŸ”® ä»Šæ—¥ã®é‹å‹¢</button>
  <button class="tb" onclick="switchTab('gacha',this)">ğŸ° ã‚¬ãƒãƒ£å ã„</button>
  <button class="tb" onclick="switchTab('daily',this)">âœ¨ ä»Šæ—¥ã®é–‹é‹</button>
  <button class="tb" onclick="switchTab('calendar',this)">ğŸ“… æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
  <button class="tb" onclick="switchTab('settings',this)">âš™ï¸ è¨­å®š</button>
</div>

<div class="err" id="errmsg"></div>

<!-- ===== TAB: FORTUNE ===== -->
<div class="tc active" id="tc-fortune">
  <!-- ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒªã‚¢ -->
  <div class="scard" style="padding:14px 18px;margin-bottom:10px" id="location-card">
    <div style="font-size:.7rem;color:var(--gold);letter-spacing:.12em;margin-bottom:12px;text-align:center">ğŸ“ å ´æ‰€ã‚’è¨­å®šï¼ˆé£²é£Ÿåº—æ¤œç´¢ã«ä½¿ç”¨ï¼‰</div>

    <!-- GPSå–å¾— -->
    <button class="loc-btn" id="loc-btn" onclick="getLocation()">
      ğŸ“¡ GPSã§ç¾åœ¨åœ°ã‚’è‡ªå‹•å–å¾—
    </button>

    <!-- åŒºåˆ‡ã‚Š -->
    <div style="display:flex;align-items:center;gap:8px;margin:8px 0">
      <div style="flex:1;height:1px;background:rgba(255,255,255,.1)"></div>
      <div style="font-size:.66rem;color:var(--muted)">ã¾ãŸã¯</div>
      <div style="flex:1;height:1px;background:rgba(255,255,255,.1)"></div>
    </div>

    <!-- æ‰‹å‹•ä½æ‰€å…¥åŠ› -->
    <div style="display:flex;gap:8px">
      <input class="api-key-input" type="text" id="manual-addr-input"
        placeholder="ä½æ‰€ãƒ»é§…åãƒ»æ–½è¨­åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šæ¸‹è°·é§…ã€å¤§é˜ªåŸå…¬åœ’ï¼‰"
        style="flex:1;background:rgba(255,255,255,.06);border:1px solid rgba(201,168,76,.25);border-radius:10px;color:var(--text);padding:9px 12px;font-size:.78rem;font-family:'Noto Serif JP',serif;"
        onkeydown="if(event.key==='Enter')geocodeManual()">
      <button onclick="geocodeManual()" style="padding:9px 14px;background:rgba(201,168,76,.2);border:1px solid rgba(201,168,76,.4);border-radius:10px;color:var(--gold);font-size:.75rem;cursor:pointer;font-family:'Noto Serif JP',serif;white-space:nowrap;transition:all .2s">ğŸ” æ¤œç´¢</button>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="loc-status" style="font-size:.7rem;color:var(--muted);margin-top:8px;min-height:18px;line-height:1.5;text-align:center"></div>
  </div>
  <div class="scard" style="padding:14px 18px">
    <div class="fr">
      <div class="fg"><label>æ˜Ÿåº§</label>
        <select id="zodiac">
          <option value="ç‰¡ç¾Šåº§" selected>ç‰¡ç¾Šåº§ â™ˆ</option><option value="ç‰¡ç‰›åº§">ç‰¡ç‰›åº§ â™‰</option>
          <option value="åŒå­åº§">åŒå­åº§ â™Š</option><option value="èŸ¹åº§">èŸ¹åº§ â™‹</option>
          <option value="ç…å­åº§">ç…å­åº§ â™Œ</option><option value="ä¹™å¥³åº§">ä¹™å¥³åº§ â™</option>
          <option value="å¤©ç§¤åº§">å¤©ç§¤åº§ â™</option><option value="è åº§">è åº§ â™</option>
          <option value="å°„æ‰‹åº§">å°„æ‰‹åº§ â™</option><option value="å±±ç¾Šåº§">å±±ç¾Šåº§ â™‘</option>
          <option value="æ°´ç“¶åº§">æ°´ç“¶åº§ â™’</option><option value="é­šåº§">é­šåº§ â™“</option>
        </select>
      </div>
      <div class="fg"><label>è¡€æ¶²å‹</label>
        <select id="blood">
          <option>Aå‹</option><option selected>Bå‹</option><option>Oå‹</option><option>ABå‹</option>
        </select>
      </div>
    </div>
    <div class="fr">
      <div class="fg"><label>å¹²æ”¯</label>
        <select id="eto">
          <option>å­</option><option>ä¸‘</option><option>å¯…</option><option>å¯</option>
          <option>è¾°</option><option>å·³</option><option>åˆ</option><option>æœª</option>
          <option>ç”³</option><option value="é…‰" selected>é…‰</option><option>æˆŒ</option><option>äº¥</option>
        </select>
      </div>
      <div class="fg"><label>ç”Ÿå¹´æœˆæ—¥</label><input type="date" id="bdate" value="1993-04-14"></div>
    </div>
    <div class="fg full" style="margin-top:6px"><label>å ´æ‰€ãƒ»çŠ¶æ³</label>
      <input type="text" id="situation" placeholder="ä¾‹ï¼šå®®å´å¸‚ ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«" value="å®®å´å¸‚ ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«">
    </div>
  </div>

  <!-- Restaurant Search Section -->
  <div class="rc c-food" style="margin:10px 0">
    <div class="ch">
      <div class="ci">ğŸ½ï¸</div>
      <div>
        <div class="ct">å‘¨è¾ºã®é£²é£Ÿåº—ã‚’æ¤œç´¢</div>
        <div class="cs" id="rest-search-cs">ğŸ“ GPSã§ç¾åœ¨åœ°å–å¾—å¾Œã«å‘¨è¾ºåº—èˆ—ã‚’è‡ªå‹•æ¤œç´¢</div>
      </div>
    </div>
    <div id="no-gps-msg" class="no-gps-msg">
      ğŸ“ ä¸Šã®ã€Œç¾åœ¨åœ°ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã§GPSå–å¾—ã™ã‚‹ã¨ã€<br>å…¨å›½ã©ã“ã§ã‚‚å‘¨è¾ºã®å®Ÿéš›ã®é£²é£Ÿåº—åãŒè¡¨ç¤ºã•ã‚Œã¾ã™
    </div>
    <div id="rest-search-bar" style="display:none;margin-bottom:10px">
      <div class="fr">
        <div class="fg">
          <label>ã‚«ãƒ†ã‚´ãƒª</label>
          <select id="rest-category">
            <option value="all">ã™ã¹ã¦</option>
            <option value="restaurant">ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³</option>
            <option value="fast_food">ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰</option>
            <option value="cafe">ã‚«ãƒ•ã‚§</option>
            <option value="ramen">ãƒ©ãƒ¼ãƒ¡ãƒ³</option>
            <option value="sushi">å¯¿å¸</option>
            <option value="izakaya">å±…é…’å±‹</option>
            <option value="udon">ã†ã©ã‚“ãƒ»è•éº¦</option>
          </select>
        </div>
        <div class="fg">
          <label>æ¤œç´¢ç¯„å›²</label>
          <select id="rest-radius">
            <option value="300">300mä»¥å†…</option>
            <option value="500" selected>500mä»¥å†…</option>
            <option value="1000">1kmä»¥å†…</option>
            <option value="2000">2kmä»¥å†…</option>
          </select>
        </div>
      </div>
      <button class="loc-btn" onclick="searchRestaurants()" style="margin-top:8px">ğŸ” å‘¨è¾ºã®é£²é£Ÿåº—ã‚’æ¤œç´¢ã™ã‚‹</button>
    </div>
    <div id="rest-results"></div>
    <div class="rest-source" id="rest-source" style="display:none">ãƒ‡ãƒ¼ã‚¿å‡ºå…¸: OpenStreetMap contributors (ODbL)</div>
  </div>

  <button class="main-btn" onclick="runFortune()">âœ¨ ä»Šã“ã®ç¬é–“ã®é‹å‹¢ã‚’å ã† âœ¨</button>
  <div id="res-fortune"></div>
</div>

<!-- ===== TAB: GACHA ===== -->
<div class="tc" id="tc-gacha">
  <div class="scard">
    <div class="sc-title">ğŸ° ã‚¬ãƒãƒ£å ã„ â€” ãƒ—ãƒ¬ã‚¤ä¸­ã‚²ãƒ¼ãƒ é¸æŠ</div>
    <div id="game-selector"></div>
    <div class="fg" style="margin-top:12px"><label>æœ¬æ—¥ã®äºˆç®—</label>
      <select id="budget">
        <option>ç„¡èª²é‡‘ï¼ˆçŸ³ã®ã¿ï¼‰</option><option>å°‘é¡ï¼ˆã€œ1,000å††ï¼‰</option>
        <option>ä¸­ç¨‹åº¦ï¼ˆã€œ5,000å††ï¼‰</option><option>å¤šã‚ï¼ˆã€œ10,000å††ï¼‰</option><option>å¤©äº•ç‹™ã„</option>
      </select>
    </div>
  </div>
  <button class="main-btn" onclick="runGacha()">ğŸ° ä»Šæ—¥ã®ã‚¬ãƒãƒ£é‹ã‚’å ã† ğŸ°</button>
  <div id="res-gacha"></div>
</div>

<!-- ===== TAB: DAILY ===== -->
<div class="tc" id="tc-daily">
  <div style="font-size:.76rem;color:var(--muted);text-align:center;margin-bottom:14px;line-height:1.7">
    æ¯æ—¥å¤‰ã‚ã‚‹é–‹é‹ã‚¢ãƒ‹ã‚½ãƒ³ãƒ»ãƒ•ãƒ¼ãƒ‰ãƒ»æœ¬ãƒ»ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤º
  </div>
  <button class="main-btn" onclick="runDaily()">âœ¨ ä»Šæ—¥ã®é–‹é‹æƒ…å ±ã‚’è¦‹ã‚‹ âœ¨</button>
  <div id="res-daily"></div>
</div>

<!-- ===== TAB: CALENDAR ===== -->
<div class="tc" id="tc-calendar">
  <div class="rc c-cal">
    <div class="ch"><div class="ci">ğŸ“…</div><div><div class="ct">æœˆé–“ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div><div class="cs">æ—¥åˆ¥é‹æ°— å…¨å è¡“è¨ˆç®—</div></div></div>
    <div class="cal-hdr">
      <button class="cal-nav" onclick="chgCalMonth(-1)">â—€</button>
      <div class="cal-title" id="cal-mtitle">--</div>
      <button class="cal-nav" onclick="chgCalMonth(1)">â–¶</button>
    </div>
    <div class="cal-grid" id="cal-grid"></div>
    <div class="cal-legend">
      <div class="cl-item"><div class="cl-dot" style="background:#FFD700"></div>æœ€å¼·å‰æ—¥</div>
      <div class="cl-item"><div class="cl-dot" style="background:rgba(201,168,76,.7)"></div>å‰æ—¥</div>
      <div class="cl-item"><div class="cl-dot" style="background:rgba(139,92,246,.5)"></div>æ™®é€š</div>
      <div class="cl-item"><div class="cl-dot" style="background:rgba(255,100,100,.4)"></div>æ³¨æ„</div>
    </div>
    <div class="cal-detail" id="cal-detail"></div>
  </div>
</div>

<!-- ===== TAB: SETTINGS ===== -->
<div class="tc" id="tc-settings">
  <div class="scard">
    <div class="sc-title">âš™ï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</div>
    <div class="fg" style="margin-bottom:10px"><label>åå‰ï¼ˆä»»æ„ï¼‰</label><input id="uname" value="å¤§æ‘æ™ƒå¹³" placeholder="ã‚ãªãŸã®åå‰"></div>
    <div class="fg" style="margin-bottom:10px"><label>ä¹æ˜Ÿ</label>
      <select id="kyusei">
        <option>ä¸€ç™½æ°´æ˜Ÿ</option><option>äºŒé»’åœŸæ˜Ÿ</option><option>ä¸‰ç¢§æœ¨æ˜Ÿ</option><option>å››ç·‘æœ¨æ˜Ÿ</option>
        <option>äº”é»„åœŸæ˜Ÿ</option><option selected>å…­ç™½é‡‘æ˜Ÿ</option><option>ä¸ƒèµ¤é‡‘æ˜Ÿ</option><option>å…«ç™½åœŸæ˜Ÿ</option><option>ä¹ç´«ç«æ˜Ÿ</option>
      </select>
    </div>
    <div class="fr" style="margin-bottom:10px">
      <div class="fg"><label>å§“</label><input id="sei" value="å¤§æ‘"></div>
      <div class="fg"><label>å</label><input id="mei" value="æ™ƒå¹³"></div>
    </div>
    <div class="fg"><label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå ´æ‰€</label><input id="defloc" value="å®®å´å¸‚ ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«"></div>
  </div>
  <button class="main-btn" style="background:linear-gradient(135deg,#2D1B5E,#4A3080,#2D1B5E)" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
  <div id="saved-msg" style="text-align:center;color:var(--green);font-size:.78rem;display:none">âœ… ä¿å­˜ã—ã¾ã—ãŸ</div>
</div>

</div>
<footer>Lucky Compass âœ¦ å…¨15ç¨®å è¡“çµ±åˆ âœ¦ APIã‚­ãƒ¼ä¸è¦ âœ¦ å®Œå…¨ç„¡æ–™</footer>

<script>
// =========================================
//  LUCKY COMPASS â€” OFFLINE DIVINATION ENGINE
//  å®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œ / APIã‚­ãƒ¼ä¸è¦
// =========================================

// â”€â”€ Stars â”€â”€
const SF = document.getElementById('sf');
for(let i=0;i<140;i++){const s=document.createElement('div');s.className='star';const sz=Math.random()*2+.4;s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${Math.random()*3+2}s;--delay:${Math.random()*3}s`;SF.appendChild(s)}
for(let i=0;i<4;i++){const s=document.createElement('div');s.className='shoot';s.style.cssText=`top:${Math.random()*40}%;left:0;--sd:${4+Math.random()*3}s;--ss:${i*3.5+Math.random()*4}s`;SF.appendChild(s)}

// â”€â”€ State â”€â”€
let coords=null, locName='å®®å´å¸‚ ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«';
let calYear=new Date().getFullYear(), calMonth=new Date().getMonth();
let selGames=new Set(['ã‚¦ãƒå¨˜','ãƒ–ãƒ«ã‚¢ã‚«','åŸç¥','å´©å£Šï¼šã‚¹ã‚¿ãƒ¼ãƒ¬ã‚¤ãƒ«','NIKKE']);

// â”€â”€ All games â”€â”€
const GAMES=['ã‚¦ãƒå¨˜','ãƒ–ãƒ«ã‚¢ã‚«','åŸç¥','å´©å£Šï¼šã‚¹ã‚¿ãƒ¼ãƒ¬ã‚¤ãƒ«','NIKKE','é³´æ½®','ã‚°ãƒ©ãƒ–ãƒ«',
  'Fate/GO','ãƒ—ãƒªã‚³ãƒR','ã‚¢ã‚ºãƒ¼ãƒ«ãƒ¬ãƒ¼ãƒ³','ãƒ˜ãƒ–ãƒãƒ³','ç™½çŒ«','å´©å£3rd',
  'ç„¡æœŸè¿·é€”','ã‚»ãƒ³ãƒ¬ã‚¹ã‚¾ãƒ¼ãƒ³ã‚¼ãƒ­','ã‚¢ãƒªã‚¹ã‚®ã‚¢','ã‚¹ã‚¯ã‚¹ãƒˆ2','ãƒã‚§ãƒ³ã‚¯ãƒ­',
  'é™°é™½å¸«','ä¿ºã‚¢ãƒ©','ãƒ‡ã‚£ã‚¹ã‚¬ã‚¤ã‚¢RPG','ã‚°ãƒ©ã‚¯ãƒ­','ã†ãŸã‚ã‚ŒLF',
  'ã¾ãŠã‚Šã‚…ã†','ãƒ‰ãƒ«ã‚¦ã‚§ãƒ–','ã·ã‚ˆã‚¯ã‚¨','DQã‚¦ã‚©ãƒ¼ã‚¯','PSO2es',
  'ã“ã®ãƒ•ã‚¡ãƒ³','ã‘ã‚‚ãƒ•ãƒ¬3','ãƒ­ã‚¹ã‚¹ãƒˆ','Master Duel','PokÃ©mon GO'];

// â”€â”€ Seeded random â”€â”€
function sRand(seed){let x=Math.sin(seed+1)*73856;return x-Math.floor(x)}
function sRandArr(seed,n){const r=[];for(let i=0;i<n;i++)r.push(sRand(seed*31+i*7919));return r}
function dateSeed(d=new Date()){return d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate()}
function userSeed(){
  const bd=document.getElementById('bdate').value||'1993-04-14';
  const parts=bd.split('-');
  return (parseInt(parts[0])||1993)*10000+(parseInt(parts[1])||4)*100+(parseInt(parts[2])||14);
}
function combinedSeed(){return dateSeed()*1000+userSeed()%1000}

// â”€â”€ å…­æ›œ â”€â”€
const ROKUYO=['å¤§å®‰','èµ¤å£','å…ˆå‹','å‹å¼•','å…ˆè² ','ä»æ»…'];
const ROKUYODESC={å¤§å®‰:'ä¸‡äº‹ã«æœ€å‰ã®æ—¥',èµ¤å£:'æ­£åˆã®ã¿å‰ã€ä»–ã¯å‡¶',å…ˆå‹:'åˆå‰å‰ã€åˆå¾Œå‡¶',å‹å¼•:'å¼•ãåˆã‚ã›ã«å‰',å…ˆè² :'åˆå‰å‡¶ã€åˆå¾Œå‰',ä»æ»…:'ä¸‡äº‹å‡¶ã®æ—¥'};
function getRokuyo(d=new Date()){const dy=Math.floor((d-new Date(d.getFullYear(),0,0))/86400000);return ROKUYO[(dy+3)%6]}

// â”€â”€ Datetime display â”€â”€
function updateDT(){
  const n=new Date();
  const days=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  document.getElementById('dt').textContent=`${n.getMonth()+1}/${n.getDate()}(${days[n.getDay()]}) ${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
  document.getElementById('ry').textContent=getRokuyo(n);
}
updateDT(); setInterval(updateDT,30000);

// â”€â”€ Game selector init â”€â”€
(function(){
  const c=document.getElementById('game-selector');
  GAMES.forEach(g=>{
    const b=document.createElement('button');b.textContent=g;
    const on=selGames.has(g);
    b.style.cssText=`padding:4px 9px;border-radius:20px;font-size:.66rem;cursor:pointer;transition:all .2s;font-family:'Noto Serif JP',serif;border:1px solid ${on?'rgba(77,200,224,.4)':'rgba(255,255,255,.12)'};background:${on?'rgba(77,200,224,.2)':'rgba(255,255,255,.04)'};color:${on?'var(--cyan)':'var(--muted)'}`;
    b.onclick=()=>{
      if(selGames.has(g)){selGames.delete(g);b.style.background='rgba(255,255,255,.04)';b.style.color='var(--muted)';b.style.borderColor='rgba(255,255,255,.12)'}
      else{selGames.add(g);b.style.background='rgba(77,200,224,.2)';b.style.color='var(--cyan)';b.style.borderColor='rgba(77,200,224,.4)'}
    };
    c.appendChild(b);
  });
})();

// â”€â”€ Tab switch â”€â”€
function switchTab(id,btn){
  document.querySelectorAll('.tc').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tb').forEach(b=>b.classList.remove('active'));
  document.getElementById('tc-'+id).classList.add('active');
  btn.classList.add('active');
  if(id==='calendar')renderCalendar();
}

// â”€â”€ Location â”€â”€
// â”€â”€ Location helpers â”€â”€
function setLocStatus(msg, color='var(--muted)') {
  const el = document.getElementById('loc-status');
  if (el) { el.textContent = msg; el.style.color = color; }
}

async function applyCoords(lat, lon, sourceName) {
  coords = { lat, lon };
  setLocStatus('ğŸ“ ä½æ‰€ã‚’è§£æä¸­...', 'var(--gold)');
  try {
    const r = await fetch(
      `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ja`,
      { headers: { 'Accept-Language': 'ja' }, signal: AbortSignal.timeout(8000) }
    );
    const d = await r.json();
    const a = d.address || {};
    locName = [a.city||a.town||a.village||a.county||'', a.suburb||a.neighbourhood||''].filter(Boolean).join('') || sourceName;
  } catch {
    locName = sourceName;
  }
  document.getElementById('loc').textContent = locName;
  document.getElementById('situation').value = locName;
  setLocStatus(`âœ… ${locName} ã§è¨­å®šã—ã¾ã—ãŸ`, 'var(--green)');
  document.getElementById('loc-btn').textContent = 'ğŸ“¡ GPSå–å¾—æ¸ˆã¿ âœ…';
  document.getElementById('loc-btn').className = 'loc-btn ok';
  showRestaurantSearch();
  setTimeout(() => searchRestaurants(), 600);
}

function getLocation() {
  const btn = document.getElementById('loc-btn');
  setLocStatus('ğŸ“¡ ä½ç½®æƒ…å ±ã‚’è¦æ±‚ä¸­...', 'var(--gold)');
  btn.textContent = 'ğŸ“¡ å–å¾—ä¸­...'; btn.disabled = true;

  if (!navigator.geolocation) {
    setLocStatus('âš ï¸ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯GPSã«éå¯¾å¿œã§ã™ã€‚æ‰‹å‹•å…¥åŠ›ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚', '#FF8080');
    btn.textContent = 'ğŸ“¡ GPSã§ç¾åœ¨åœ°ã‚’è‡ªå‹•å–å¾—'; btn.disabled = false; return;
  }

  // HTTPS ãƒã‚§ãƒƒã‚¯
  if (location.protocol === 'file:') {
    setLocStatus('âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯GPSãŒä½¿ãˆã¾ã›ã‚“ã€‚ä½æ‰€ã‚’æ‰‹å‹•å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', '#FF8080');
    btn.textContent = 'ğŸ“¡ GPSã§ç¾åœ¨åœ°ã‚’è‡ªå‹•å–å¾—'; btn.disabled = false; return;
  }

  const timeout = setTimeout(() => {
    setLocStatus('â±ï¸ GPSãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€‚æ‰‹å‹•å…¥åŠ›ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚', '#FF8080');
    btn.textContent = 'ğŸ“¡ GPSã§ç¾åœ¨åœ°ã‚’è‡ªå‹•å–å¾—'; btn.disabled = false;
  }, 12000);

  navigator.geolocation.getCurrentPosition(
    async (pos) => {
      clearTimeout(timeout);
      btn.disabled = false;
      await applyCoords(pos.coords.latitude, pos.coords.longitude,
        `${pos.coords.latitude.toFixed(4)},${pos.coords.longitude.toFixed(4)}`);
    },
    (err) => {
      clearTimeout(timeout);
      btn.textContent = 'ğŸ“¡ GPSã§ç¾åœ¨åœ°ã‚’è‡ªå‹•å–å¾—'; btn.disabled = false;
      const msgs = {
        1: 'âŒ ä½ç½®æƒ…å ±ã®è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§è¨±å¯ã™ã‚‹ã‹ã€æ‰‹å‹•å…¥åŠ›ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚',
        2: 'âŒ ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•å…¥åŠ›ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚',
        3: 'â±ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚æ‰‹å‹•å…¥åŠ›ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚'
      };
      setLocStatus(msgs[err.code] || 'âŒ GPSå–å¾—å¤±æ•—ã€‚æ‰‹å‹•å…¥åŠ›ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚', '#FF8080');
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
  );
}

// æ‰‹å‹•ä½æ‰€å…¥åŠ›â†’Nominatim geocoding
async function geocodeManual() {
  const input = document.getElementById('manual-addr-input').value.trim();
  if (!input) { setLocStatus('âš ï¸ ä½æ‰€ãƒ»æ–½è¨­åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', '#FF8080'); return; }

  setLocStatus('ğŸ” ä½æ‰€ã‚’æ¤œç´¢ä¸­...', 'var(--gold)');
  try {
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(input + ' æ—¥æœ¬')}&format=json&limit=1&accept-language=ja`;
    const r = await fetch(url, { signal: AbortSignal.timeout(10000) });
    const data = await r.json();

    if (!data || data.length === 0) {
      setLocStatus('âš ï¸ ã€Œ' + input + 'ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚', '#FF8080');
      return;
    }

    const place = data[0];
    const lat = parseFloat(place.lat);
    const lon = parseFloat(place.lon);
    const displayName = place.display_name.split(',').slice(0,3).join(' ');
    locName = input;
    document.getElementById('situation').value = input;
    await applyCoords(lat, lon, input);
    setLocStatus(`âœ… ã€Œ${displayName}ã€ä»˜è¿‘ã§è¨­å®šã—ã¾ã—ãŸ`, 'var(--green)');

  } catch (err) {
    setLocStatus('âŒ ä½æ‰€æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', '#FF8080');
  }
}

function showErr(msg){const e=document.getElementById('errmsg');e.textContent=msg;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),4000)}

// ============================================
//  CORE DIVINATION ENGINE â€” å…¨15ç¨®å è¡“
// ============================================

// è¥¿æ´‹å æ˜Ÿè¡“ã‚¹ã‚³ã‚¢ï¼ˆæ˜Ÿåº§Ã—æ—¥ä»˜ï¼‰
const ZODIAC_BASE={ç‰¡ç¾Šåº§:85,ç‰¡ç‰›åº§:78,åŒå­åº§:82,èŸ¹åº§:76,ç…å­åº§:88,ä¹™å¥³åº§:80,å¤©ç§¤åº§:83,è åº§:79,å°„æ‰‹åº§:86,å±±ç¾Šåº§:77,æ°´ç“¶åº§:84,é­šåº§:81};
function westernScore(seed){const z=document.getElementById('zodiac').value;const base=ZODIAC_BASE[z]||80;return Math.min(99,Math.max(45,Math.round(base+(sRand(seed*3)-0.5)*30)))}

// ã‚¿ãƒ­ãƒƒãƒˆ
const TAROT=[{n:'å¤ªé™½',s:95,i:'â˜€ï¸',msg:'æ˜ã‚‹ã„æˆåŠŸã¨å–œã³ã€‚ç©æ¥µçš„ãªè¡Œå‹•ãŒå‰ã€‚'},{n:'æ˜Ÿ',s:85,i:'â­',msg:'å¸Œæœ›ã¨ç†æƒ³ã€‚å¤¢ã«å‘ã‹ã£ã¦é€²ã‚€å¥½æ©Ÿã€‚'},{n:'é‹å‘½ã®è¼ª',s:80,i:'â˜¸ï¸',msg:'è»¢æ›æœŸã€‚æµã‚Œã«ä¹—ã£ã¦å¤§ããé£›èºã€‚'},{n:'åŠ›',s:82,i:'ğŸ¦',msg:'å†…ãªã‚‹åŠ›ãŒè¦šé†’ã€‚ç²˜ã‚Šå¼·ã•ãŒå®Ÿã‚’çµã¶ã€‚'},{n:'é­”è¡“å¸«',s:88,i:'ğŸª„',msg:'æ‰èƒ½å…¨é–‹ã€‚ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å³è¡Œå‹•ã«ç§»ã™ã¹ãæ—¥ã€‚'},{n:'å¥³å¸',s:86,i:'ğŸ‘‘',msg:'è±Šã‹ã•ã¨å‰µé€ åŠ›ã€‚ç¾ã¨æ„›ãŒå¼•ãå¯„ã›ã‚‰ã‚Œã‚‹ã€‚'},{n:'ä¸–ç•Œ',s:92,i:'ğŸŒ',msg:'å®Œæˆã¨é”æˆã€‚å¤§ããªç›®æ¨™ãŒå®Ÿç¾ã™ã‚‹äºˆå…†ã€‚'},{n:'æœˆ',s:68,i:'ğŸŒ™',msg:'ç›´æ„Ÿã‚’ä¿¡ã˜ã¦ã€‚è¦‹ãˆãªã„ã‚‚ã®ã«æ³¨æ„ã€‚'},{n:'å¡”',s:55,i:'ğŸ—¼',msg:'å¤‰åŒ–ã®äºˆå…†ã€‚å›ºåŸ·ã‚’æ‰‹æ”¾ã™ã¨æ–°ãŸãªé“ãŒã€‚'},{n:'å¯©åˆ¤',s:75,i:'ğŸ“¯',msg:'å†ç”Ÿã¨ç›®è¦šã‚ã€‚éå»ã‚’æ¸…ç®—ã—ã¦å‰é€²ã€‚'},{n:'é«˜ç­‰å¥³å¸ç¥­',s:83,i:'ğŸ“œ',msg:'æ™ºæ…§ã¨ç¥ç§˜ã€‚å†…çœã™ã‚‹ã“ã¨ã§ç­”ãˆã‚’å¾—ã‚‹ã€‚'},{n:'çš‡å¸',s:87,i:'âš”ï¸',msg:'æ¨©å¨ã¨å®‰å®šã€‚ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®ã™ã‚‹æ—¥ã€‚'}];
function tarotDraw(seed){return TAROT[Math.floor(sRand(seed*7)*TAROT.length)]}

// æ•°ç§˜è¡“ï¼ˆå‘½æ•°è¨ˆç®—ï¼‰
function calcNumerology(bdate){
  const s=bdate.replace(/-/g,'').split('').reduce((a,c)=>a+parseInt(c),0);
  let n=s;while(n>9&&n!==11&&n!==22&&n!==33){const ds=String(n).split('').map(Number);n=ds.reduce((a,b)=>a+b,0)}
  return n;
}
const NUMER_MSG={1:'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã®æ—¥ã€‚æ±ºæ–­ã¨è¡Œå‹•ã§é‹æ°—UPã€‚',2:'å”èª¿ã¨ç›´æ„Ÿã®æ—¥ã€‚ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®çµ†ãŒå¼·ã¾ã‚‹ã€‚',3:'å‰µé€ ã¨è¡¨ç¾ã®æ—¥ã€‚ã‚¢ã‚¤ãƒ‡ã‚¢ã¨ç¬‘ã„ãŒå¹¸é‹ã‚’å‘¼ã¶ã€‚',4:'å®‰å®šã¨åŸºç›¤ã®æ—¥ã€‚åœ°é“ãªåŠªåŠ›ãŒå¿…ãšå ±ã‚ã‚Œã‚‹ã€‚',5:'å¤‰åŒ–ã¨è‡ªç”±ã®æ—¥ã€‚æ–°ã—ã„å†’é™ºã«è¸ã¿å‡ºã™ã¨ãã€‚',6:'æ„›ã¨èª¿å’Œã®æ—¥ã€‚å®¶æ—ãƒ»ä»²é–“ã¨ã®çµ†ãŒæ·±ã¾ã‚‹ã€‚',7:'ç›´æ„Ÿã¨æ¢æ±‚ã®æ—¥ã€‚å†…çœã¨å­¦ã³ã§æ™ºæ…§ãŒé–‹èŠ±ã€‚',8:'åŠ›ã¨è±Šã‹ã•ã®æ—¥ã€‚ãƒ“ã‚¸ãƒã‚¹ã¨é‡‘é‹ãŒçµ¶å¥½èª¿ã€‚',9:'å®Œæˆã¨æ…ˆæ„›ã®æ—¥ã€‚ä¸ãˆã‚‹ã“ã¨ã§å…¨ã¦ãŒè¿”ã£ã¦ãã‚‹ã€‚',11:'ç›´æ„Ÿã®æ—¥ã€‚ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«ãªæ„Ÿå—æ€§ãŒæœ€å¤§åŒ–ã€‚',22:'ãƒã‚¹ã‚¿ãƒ¼ã®æ—¥ã€‚å¤§ããªãƒ“ã‚¸ãƒ§ãƒ³ã‚’å½¢ã«ã™ã‚‹åŠ›ã€‚',33:'å¥‰ä»•ã®æ—¥ã€‚ä»–è€…ã¸ã®æ„›ã¨è²¢çŒ®ãŒæœ€å¤§ã®å¹¸é‹ã€‚'};
function numerScore(seed,nm){const base={1:80,2:75,3:85,4:78,5:88,6:82,7:79,8:87,9:83,11:90,22:95,33:92};return Math.min(99,Math.max(45,Math.round((base[nm]||80)+(sRand(seed*11)-0.5)*20)))}

// ãƒ«ãƒ¼ãƒ³
const RUNES=[{n:'ãƒ•ã‚§ãƒ•',i:'áš ',mean:'å¯Œã¨ç¹æ „',s:88},{n:'ã‚¢ãƒ³ã‚¹ã‚º',i:'áš¨',mean:'çŸ¥æµã¨ä¼é”',s:82},{n:'ã‚½ã‚¦ãƒ«',i:'á›Š',mean:'å‹åˆ©ã®å¤ªé™½',s:90},{n:'ãƒ†ã‚£ãƒ¼ãƒ«',i:'á›',mean:'æ­£ç¾©ã¨å‹‡æ°—',s:78},{n:'ã‚¦ãƒ«',i:'áš¢',mean:'åŠ›ã¨æˆé•·',s:85},{n:'ãƒã‚¬ãƒ«',i:'ášº',mean:'å¤‰é©ã¨å†ç”Ÿ',s:65},{n:'ã‚²ãƒœ',i:'áš·',mean:'è´ˆã‚Šç‰©ã¨çµ†',s:87},{n:'ãƒŠã‚¦ã‚º',i:'áš¾',mean:'åˆ¶ç´„ã®ä¸­ã®çŸ¥æµ',s:72},{n:'ã‚¤ãƒ³ã‚°',i:'á›œ',mean:'è±Šç©£ã¨å®Œæˆ',s:89},{n:'ãƒ©ã‚°ã‚º',i:'á›š',mean:'æµã‚Œã¨ç›´æ„Ÿ',s:80}];
function runeDraw(seed){return RUNES[Math.floor(sRand(seed*13)*RUNES.length)]}

// ä¹æ˜Ÿæ°—å­¦
const KYUSEI_LUCK={ä¸€ç™½æ°´æ˜Ÿ:[.7,.9,.65,.8,.85,.75,.7,.9,.6,.8,.85,.7],äºŒé»’åœŸæ˜Ÿ:[.85,.7,.9,.65,.8,.85,.75,.7,.9,.6,.8,.85],ä¸‰ç¢§æœ¨æ˜Ÿ:[.8,.85,.7,.9,.65,.8,.85,.75,.7,.9,.6,.8],å››ç·‘æœ¨æ˜Ÿ:[.6,.8,.85,.7,.9,.65,.8,.85,.75,.7,.9,.6],äº”é»„åœŸæ˜Ÿ:[.9,.6,.8,.85,.7,.9,.65,.8,.85,.75,.7,.9],å…­ç™½é‡‘æ˜Ÿ:[.85,.75,.7,.9,.6,.8,.85,.7,.9,.65,.8,.85],ä¸ƒèµ¤é‡‘æ˜Ÿ:[.7,.9,.6,.8,.85,.75,.7,.9,.65,.8,.85,.7],å…«ç™½åœŸæ˜Ÿ:[.65,.8,.85,.75,.7,.9,.6,.8,.85,.7,.9,.65],ä¹ç´«ç«æ˜Ÿ:[.75,.7,.9,.6,.8,.85,.75,.7,.9,.65,.8,.85]};
function kyuseiScore(seed){
  const ky=document.getElementById('kyusei')?.value||'å…­ç™½é‡‘æ˜Ÿ';
  const now=new Date(); const mIdx=now.getMonth();
  const base=KYUSEI_LUCK[ky]?KYUSEI_LUCK[ky][mIdx]:0.8;
  return Math.min(99,Math.max(45,Math.round(base*100+(sRand(seed*17)-0.5)*18)));
}

// å››æŸ±æ¨å‘½
const SHISHU_HEAVENLY=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
const SHISHU_EARTHLY=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
function shichuScore(seed){return Math.min(99,Math.max(45,Math.round(76+(sRand(seed*19)-0.5)*26)))}
function shichuMsg(seed){
  const h=SHISHU_HEAVENLY[Math.floor(sRand(seed*23)*10)];
  const e=SHISHU_EARTHLY[Math.floor(sRand(seed*29)*12)];
  const msgs=[`${h}${e}ã®æ°—ãŒæµã‚Œã€è¡Œå‹•åŠ›ãŒé«˜ã¾ã‚‹æ—¥ã€‚`,`æ—¥ä¸»ã¨æœ¬æ—¥ã®å¹²æ”¯ãŒèª¿å’Œã—ã€çŸ¥æ€§ã¨åˆ¤æ–­åŠ›ãŒå†´ãˆã‚‹ã€‚`,`å¤©å¹²ã¨åœ°æ”¯ãŒç›¸ç”Ÿã—ã€é‡‘é‹ã¨äººé–“é–¢ä¿‚ã«å¥½å½±éŸ¿ã€‚`,`å®˜æ˜ŸãŒè¼ãæ—¥ã€‚ä»•äº‹é¢ã§è‰¯ã„è©•ä¾¡ã‚’å¾—ã‚‰ã‚Œã‚‹äºˆå…†ã€‚`,`è²¡æ˜ŸãŒæ´»æ€§åŒ–ã€‚äºˆæœŸã›ã¬åå…¥ã‚„æ©æµã®å¯èƒ½æ€§ã€‚`];
  return msgs[Math.floor(sRand(seed*31)*msgs.length)];
}

// ç´«å¾®æ–—æ•°
const ZIWEI_STARS=['ç´«å¾®æ˜Ÿ','å¤©æ©Ÿæ˜Ÿ','å¤ªé™½æ˜Ÿ','æ­¦æ›²æ˜Ÿ','å¤©åŒæ˜Ÿ','å»‰è²æ˜Ÿ','å¤©åºœæ˜Ÿ','å¤ªé™°æ˜Ÿ','è²ªç‹¼æ˜Ÿ','å·¨é–€æ˜Ÿ'];
function ziweiScore(seed){return Math.min(99,Math.max(45,Math.round(74+(sRand(seed*37)-0.5)*24)))}
function ziweiMsg(seed){const s=ZIWEI_STARS[Math.floor(sRand(seed*41)*ZIWEI_STARS.length)];const msgs=[`${s}ãŒå‘½å®®ã«å…¥ã‚Šã€å€‹äººçš„ãªé‹æ°—ãŒæœ€å¤§åŒ–ã€‚`,`${s}ã®å½±éŸ¿ã§è²¡å¸›å®®ãŒæ´»æ€§åŒ–ã€‚é‡‘é‹ã«æ³¨ç›®ã€‚`,`${s}ãŒé·ç§»å®®ã«é®åº§ã—ã€è‰¯ã„å¤‰åŒ–ãŒè¨ªã‚Œã‚‹ã€‚`];return msgs[Math.floor(sRand(seed*43)*msgs.length)]}

// é¢¨æ°´
const FENGSHUI_DIR=['åŒ—','åŒ—æ±','æ±','å—æ±','å—','å—è¥¿','è¥¿','åŒ—è¥¿'];
const FENGSHUI_COLOR=['ç™½','é’','ç·‘','é»„','èµ¤','æ©™','é‡‘','ç´«'];
function fengshuiScore(seed){return Math.min(99,Math.max(45,Math.round(73+(sRand(seed*47)-0.5)*26)))}
function fengshuiDir(seed){return FENGSHUI_DIR[Math.floor(sRand(seed*53)*8)]}
function fengshuiMsg(seed,dir){return `${dir}ã®æ–¹ä½ã«é–‹é‹ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒé›†ä¸­ã€‚${FENGSHUI_COLOR[Math.floor(sRand(seed*59)*8)]}è‰²ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’èº«ã«ç€ã‘ã‚‹ã¨å‰ã€‚`}

// 0å­¦å ã„ï¼ˆç®—å‘½å­¦ãƒ™ãƒ¼ã‚¹ï¼‰
function zeroScore(seed){return Math.min(99,Math.max(45,Math.round(71+(sRand(seed*61)-0.5)*28)))}

// å§“ååˆ¤æ–­
function seimeiScore(){
  const sei=document.getElementById('sei')?.value||'å¤§æ‘';
  const mei=document.getElementById('mei')?.value||'æ™ƒå¹³';
  // ç°¡ç•¥ç‰ˆï¼šæ–‡å­—æ•°Ã—å¹³æ–¹ã§ã‚¹ã‚³ã‚¢ç®—å‡º
  const strokes=sei.length*7+mei.length*5;
  const base=60+((strokes%40));
  return Math.min(99,Math.max(50,base));
}

// è¡€æ¶²å‹
const BLOOD_DAILY={Aå‹:{msg:'å‡ å¸³é¢ãªæœ¬é ˜ç™ºæ®ã®æ—¥ã€‚è¨ˆç”»é€šã‚Šã«é€²ã‚ã‚‹ã¨å‰ã€‚',base:78},Bå‹:{msg:'è‡ªç”±ãªç™ºæƒ³åŠ›ãŒç‚¸è£‚ã™ã‚‹æ—¥ã€‚ç›´æ„Ÿã‚’ä¿¡ã˜ã¦å‹•ã“ã†ã€‚',base:84},Oå‹:{msg:'å¤§ã‚‰ã‹ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå‘¨ã‚Šã‚’å‹•ã‹ã™æ—¥ã€‚ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—â—',base:82},ABå‹:{msg:'äºŒé¢æ€§ãŒå¥½è»¢ã™ã‚‹æ—¥ã€‚æŸ”è»Ÿãªåˆ¤æ–­ãŒæœ€å¤§ã®æ­¦å™¨ã€‚',base:86}};
function bloodScore(seed){const b=document.getElementById('blood').value;const base=BLOOD_DAILY[b]?.base||80;return Math.min(99,Math.max(45,Math.round(base+(sRand(seed*67)-0.5)*22)))}

// ç®—å‘½å­¦
function sanmeiScore(seed){return Math.min(99,Math.max(45,Math.round(75+(sRand(seed*71)-0.5)*24)))}

// å…­æ›œã‚¹ã‚³ã‚¢
const ROKUYO_SCORE={å¤§å®‰:92,èµ¤å£:45,å…ˆå‹:70,å‹å¼•:75,å…ˆè² :62,ä»æ»…:38};
function rokuyoScore(){return ROKUYO_SCORE[getRokuyo()]||65}

// ãŠã¿ãã˜
const OMIKUJI=[{r:'å¤§å‰',w:14,col:'#FFD700'},{r:'ä¸­å‰',w:26,col:'var(--gold)'},{r:'å°å‰',w:22,col:'#90EE90'},{r:'å‰',w:20,col:'#87CEEB'},{r:'æœ«å‰',w:11,col:'#DDA0DD'},{r:'å‡¶',w:5,col:'#FF8080'},{r:'å¤§å‡¶',w:2,col:'#FF4444'}];
const OMIKUJI_MSG={å¤§å‰:'ä¸‡äº‹ã«æœ€é«˜ã®é‹ãŒå·¡ã‚Šã¾ã™ã€‚å¤§ããªæ±ºæ–­ãƒ»è¡Œå‹•ãƒ»ã‚¬ãƒãƒ£å…¨ã¦ã«å‰ï¼',ä¸­å‰:'å…¨ä½“çš„ã«è‰¯ã„æµã‚Œã€‚è‡ªä¿¡ã‚’æŒã£ã¦é€²ã‚ã¦ä¸‹ã•ã„ã€‚',å°å‰:'å°ã•ãªå¹¸ã›ãŒç©ã¿é‡ãªã‚‹æ—¥ã€‚ç€å®Ÿã«å‰é€²ã‚’ã€‚',å‰:'è‰¯ã„æ—¥ã§ã™ã€‚æ—¥å¸¸ã‚’ä¸å¯§ã«ã€‚',æœ«å‰:'å¾ŒåŠã‹ã‚‰é‹æ°—ä¸Šæ˜‡ã€‚åˆå¾Œä»¥é™ã®è¡Œå‹•ãŒå‰ã€‚',å‡¶:'ä»Šæ—¥ã¯æ…é‡ã«ã€‚ã‚¬ãƒãƒ£ã¯æ˜æ—¥ä»¥é™æ¨å¥¨ã€‚',å¤§å‡¶:'ä¸‡äº‹æ§ãˆã‚ã«ã€‚ç¥ç¤¾å‚æ‹ã§ãŠç¥“ã„ã‚’ã€‚'};
function drawOmikuji(seed){
  let r=sRand(seed*73)*100,cum=0;
  for(const o of OMIKUJI){cum+=o.w;if(r<cum)return o}
  return OMIKUJI[0];
}

// â”€â”€ ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®— â”€â”€
function computeAll(){
  const seed=combinedSeed();const now=new Date();
  const ws=westernScore(seed);
  const tarot=tarotDraw(seed);
  const bdate=document.getElementById('bdate').value||'1993-04-14';
  const nm=calcNumerology(bdate);
  const ns=numerScore(seed,nm);
  const rune=runeDraw(seed);
  const ks=kyuseiScore(seed);
  const ss=shichuScore(seed);
  const zs=ziweiScore(seed);
  const fs=fengshuiScore(seed);
  const fdir=fengshuiDir(seed);
  const zeros=zeroScore(seed);
  const seimeis=seimeiScore();
  const bs=bloodScore(seed);
  const sms=sanmeiScore(seed);
  const rs=rokuyoScore();
  const omi=drawOmikuji(seed);

  const scores=[ws,tarot.s,ns,rune.s,ks,ss,zs,fs,zeros,seimeis,bs,sms,rs];
  const total=Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);

  // Lucky hours
  const hourBases=[38,32,52,82,79,72,88,91,75,92,85,52];
  const hours=hourBases.map((b,i)=>{
    const sc=Math.min(99,Math.max(30,Math.round(b+(sRand(seed*79+i*83)-0.5)*18)));
    return {time:`${String(i*2).padStart(2,'0')}:00-${String(i*2+2).padStart(2,'0')}:00`,score:sc};
  }).sort((a,b)=>b.score-a.score);

  // Lucky places (location-aware)
  const loc=document.getElementById('situation').value||locName||'å®®å´å¸‚';
  const placeTypes=[
    {cat:'ç¥ç¤¾ãƒ»å¯º',spots:`${loc}å‘¨è¾ºã®ç¥ç¤¾ãƒ»å¯ºé™¢`,reason:'ä¹æ˜Ÿæ°—å­¦ã®å‰æ–¹ä½ã¨é‡ãªã‚‹è–åŸŸã€‚å‚æ‹ã§é‹æ°—ãŒæµ„åŒ–ã•ã‚Œã¾ã™ã€‚',dir:fdir},
    {cat:'è‡ªç„¶ãƒ»å…¬åœ’',spots:`${loc}å‘¨è¾ºã®å…¬åœ’ãƒ»ç·‘åœ°`,reason:`${tarot.n}ã®ã‚«ãƒ¼ãƒ‰ãŒç¤ºã™ã€Œè‡ªç„¶ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€ã¨å…±é³´ã™ã‚‹å ´æ‰€ã€‚`,dir:FENGSHUI_DIR[(FENGSHUI_DIR.indexOf(fdir)+2)%8]},
    {cat:'ã‚«ãƒ•ã‚§ãƒ»é£²é£Ÿ',spots:`${loc}å‘¨è¾ºã®é£²é£Ÿåº—ãƒ»ã‚«ãƒ•ã‚§`,reason:'é¢¨æ°´ã®æ°´ã®æ°—ãŒæµã‚Œã€äººã¨ã®ç¸ã¨é‡‘é‹ãŒé«˜ã¾ã‚‹ã‚¨ãƒªã‚¢ã€‚',dir:FENGSHUI_DIR[(FENGSHUI_DIR.indexOf(fdir)+4)%8]},
  ];

  // Lucky foods
  const bloodFoods={Bå‹:[{n:'ã†ã©ã‚“ãƒ»ãã°',c:'ç™½',t:'ãƒ©ãƒ³ãƒ',s:'ã†ã©ã‚“å±‹ãƒ»è•éº¦å±‹',r:'ç™½ã„é£ŸæãŒå…­ç™½é‡‘æ˜Ÿã®é‡‘æ°—ã‚’é«˜ã‚ã€é›†ä¸­åŠ›ãŒæŒç¶šã€‚'},{n:'é¶æ–™ç†',c:'é»„',t:'å¤•é£Ÿ',s:'ç„¼ãé³¥ãƒ»é¶æ–™ç†åº—',r:'å¹²æ”¯ãƒ»é…‰ï¼ˆé¶ï¼‰ã‚’å–ã‚Šè¾¼ã‚€ã“ã¨ã§æœ¬æ¥ã®åŠ›ãŒè¦šé†’ã€‚'},{n:'ã„ã¡ã”ç³»ã‚¹ã‚¤ãƒ¼ãƒ„',c:'èµ¤',t:'ãŠã‚„ã¤',s:'ã‚«ãƒ•ã‚§ãƒ»ã‚¹ã‚¤ãƒ¼ãƒ„åº—',r:'èµ¤ã„é£ŸæãŒç‰¡ç¾Šåº§ã®ç«ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è£œçµ¦ã€‚'}]};
  const zodiac=document.getElementById('zodiac').value;
  const foods=bloodFoods[document.getElementById('blood').value]||bloodFoods['Bå‹'];

  // Verdict
  const verdicts=[
    {min:90,v:'å¤§å‰ âœ¦ æœ€å¼·ã®é–‹é‹æ—¥ï¼',col:'#FFD700'},
    {min:80,v:'ä¸­å‰ âœ¦ é‹æ°—ä¸Šæ˜‡ä¸­',col:'var(--gold-light)'},
    {min:70,v:'å‰ âœ¦ è‰¯ã„æµã‚Œã®æ—¥',col:var_green()},
    {min:60,v:'å°å‰ âœ¦ ç€å®Ÿã«å‰é€²',col:'#87CEEB'},
    {min:0,v:'æœ«å‰ âœ¦ æ…é‡ãªä¸€æ—¥ã‚’',col:'var(--muted)'}
  ];
  const verdict=verdicts.find(v=>total>=v.min)||verdicts[verdicts.length-1];

  return{total,verdict,ws,tarot,nm,ns,rune,ks,ss,ssMsg:shichuMsg(seed),zs,zsMsg:ziweiMsg(seed),fs,fdir,fsMsg:fengshuiMsg(seed,fdir),zeros,seimeis,bs,sms,rs,omi,hours,places:placeTypes,foods,seed,nm,now};
}
function var_green(){return '#50C878'}

// â”€â”€ Render: Fortune â”€â”€
function runFortune(){
  const d=computeAll();
  const scoreColor=s=>s>=90?'#FFD700':s>=80?'var(--gold-light)':s>=70?'var(--green)':s>=60?'#87CEEB':'var(--muted)';
  const stars=s=>'â˜…'.repeat(Math.round(s/20))+'â˜†'.repeat(5-Math.round(s/20));
  const topHours=d.hours.slice(0,4);
  const situation=document.getElementById('situation').value||locName;

  // Divination messages
  const divs=[
    {n:'è¥¿æ´‹å æ˜Ÿè¡“',s:d.ws,msg:`${document.getElementById('zodiac').value}ï¼šä»Šæ—¥ã¯æœˆã®ä½ç½®ãŒç«æ˜Ÿã¨èª¿å’Œã€‚${d.tarot.msg}`},
    {n:'ã‚¿ãƒ­ãƒƒãƒˆ',s:d.tarot.s,msg:`ã€Œ${d.tarot.n}ã€${d.tarot.i} â€” ${d.tarot.msg}`},
    {n:'æ•°ç§˜è¡“',s:d.ns,msg:`å‘½æ•°${d.nm}ï¼š${NUMER_MSG[d.nm]||'å¤‰åŒ–ã¨æˆé•·ã®æ•°ã€‚ä»Šæ—¥ã‚’å¤§åˆ‡ã«ã€‚'}`},
    {n:'ãƒ«ãƒ¼ãƒ³',s:d.rune.s,msg:`${d.rune.i}${d.rune.n}ï¼ˆ${d.rune.mean}ï¼‰â€” ä»Šæ—¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã€Œ${d.rune.mean}ã€ã€‚`},
    {n:'ä¹æ˜Ÿæ°—å­¦',s:d.ks,msg:`${document.getElementById('kyusei')?.value||'å…­ç™½é‡‘æ˜Ÿ'}ï¼šä»Šæœˆã®æ°—ã®æµã‚Œã¨ã®ç›¸æ€§ã‹ã‚‰é‹å‹¢ã‚’é‘‘å®šã€‚`},
    {n:'å››æŸ±æ¨å‘½',s:d.ss,msg:d.ssMsg},
    {n:'ç´«å¾®æ–—æ•°',s:d.zs,msg:d.zsMsg},
    {n:'é¢¨æ°´',s:d.fs,msg:d.fsMsg},
    {n:'è¡€æ¶²å‹å ã„',s:d.bs,msg:`${document.getElementById('blood').value}ï¼š${BLOOD_DAILY[document.getElementById('blood').value]?.msg||'æœ¬æ¥ã®åŠ›ãŒç™ºæ®ã•ã‚Œã‚‹æ—¥ã€‚'}`},
    {n:'å…­æ›œ',s:d.rs,msg:`${getRokuyo()}ï¼š${ROKUYODESC[getRokuyo()]||''}`},
  ];

  const circumference=2*Math.PI*54;
  const dash=circumference*(d.total/100);
  const gap=circumference-dash;

  let html=`
  <div class="score-wrap">
    <div class="score-ring">
      <svg viewBox="0 0 120 120">
        <circle cx="60" cy="60" r="54" stroke="rgba(201,168,76,.15)" stroke-width="10" fill="none"/>
        <circle cx="60" cy="60" r="54" stroke="url(#sg)" stroke-width="10" fill="none"
          stroke-dasharray="${dash} ${gap}" stroke-linecap="round"/>
        <defs><linearGradient id="sg" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#7B5EA7"/><stop offset="100%" stop-color="#d4af37"/>
        </linearGradient></defs>
      </svg>
      <div class="score-inner">
        <div class="score-num">${d.total}</div>
        <div class="score-lbl">LUCKY</div>
      </div>
    </div>
    <div class="verdict" style="color:${d.verdict.col}">${d.verdict.v}</div>
    <div style="font-size:.7rem;color:var(--muted)">${new Date().getMonth()+1}æœˆ${new Date().getDate()}æ—¥ âœ¦ ${situation} âœ¦ ${getRokuyo()}</div>
  </div>

  <div class="rc c-time">
    <div class="ch"><div class="ci">â°</div><div><div class="ct">ãƒ©ãƒƒã‚­ãƒ¼ã‚¿ã‚¤ãƒ </div><div class="cs">é‹æ°—ãƒ”ãƒ¼ã‚¯æ™‚é–“å¸¯ TOP4</div></div></div>
    <div class="tgrid">${topHours.map(h=>`
      <div class="titem">
        <div class="trange">${h.time}</div>
        <div class="tscore" style="color:${scoreColor(h.score)}">${h.score}ç‚¹</div>
        <div class="tlabel">${h.score>=90?'ğŸŒŸæœ€å¼·ãƒ”ãƒ¼ã‚¯':h.score>=80?'âœ¦ å‰æ™‚é–“':h.score>=70?'â— è‰¯å¥½':'â–³ æ™®é€š'}</div>
      </div>`).join('')}
    </div>
  </div>

  <div class="rc c-place" id="lucky-spot-card">
    <div class="ch"><div class="ci">ğŸ“</div><div><div class="ct">ãƒ©ãƒƒã‚­ãƒ¼ã‚¹ãƒãƒƒãƒˆ</div><div class="cs" id="spot-card-sub">å‘¨è¾ºã®é–‹é‹ã‚¹ãƒãƒƒãƒˆã‚’æ¤œç´¢ä¸­...</div></div></div>
    <div id="lucky-spot-results">
      <div class="spot-loading">âœ¨ å‘¨è¾ºã‚¹ãƒãƒƒãƒˆã‚’å–å¾—ä¸­...</div>
    </div>
  </div>

  <div class="rc c-food">
    <div class="ch"><div class="ci">ğŸ½ï¸</div><div><div class="ct">ãƒ©ãƒƒã‚­ãƒ¼ãƒ•ãƒ¼ãƒ‰</div><div class="cs">é‹æ°—UPé£Ÿæ TOP3</div></div></div>
    ${d.foods.map((f,i)=>`
    <div class="fi">
      <div class="fr2">ğŸ€ ç¬¬${i+1}ä½ | ${f.c}ã®é£Ÿã¹ç‰© | ${f.t}</div>
      <div class="pn">${f.n}</div>
      <div class="ps">ğŸª ${f.s}</div>
      <div class="pd">${f.r}</div>
    </div>`).join('')}
  </div>

  <div class="rc c-div">
    <div class="ch"><div class="ci">ğŸ”®</div><div><div class="ct">å è¡“åˆ¥è©³ç´°</div><div class="cs">å…¨å è¡“ã‚¹ã‚³ã‚¢ & ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div></div></div>
    ${divs.map(d=>`
    <div class="pbar-wrap">
      <div class="pbar-hdr"><span class="pbar-name">âœ¦ ${d.n}</span><span class="pbar-score">${d.s}pt</span></div>
      <div class="pbar"><div class="pbar-fill" style="width:${d.s}%"></div></div>
      <div style="font-size:.73rem;color:var(--muted);margin-top:4px;line-height:1.6">${d.msg}</div>
    </div>`).join('')}
  </div>

  <div class="rc" style="background:linear-gradient(135deg,rgba(201,168,76,.08),rgba(45,27,94,.3))">
    <div class="ch"><div class="ci">ğŸ“¿</div><div><div class="ct">ãŠã¿ãã˜</div></div></div>
    <div style="text-align:center;padding:10px 0">
      <div style="font-family:'Zen Old Mincho',serif;font-size:2.2rem;color:${d.omi.col};filter:drop-shadow(0 0 12px ${d.omi.col})">${d.omi.r}</div>
      <div style="font-size:.82rem;color:var(--text);margin-top:10px;line-height:1.8">${OMIKUJI_MSG[d.omi.r]||''}</div>
    </div>
  </div>

  <div class="li-grid">
    <div class="li-item"><div class="li-icon">ğŸ¨</div><div><div class="li-cat">ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼</div><div class="li-name">${getLuckyColor(d.seed)}</div></div></div>
    <div class="li-item"><div class="li-icon">ğŸ”¢</div><div><div class="li-cat">ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼</div><div class="li-name">${getLuckyNumbers(d.seed)}</div></div></div>
    <div class="li-item"><div class="li-icon">ğŸ’</div><div><div class="li-cat">ãƒ©ãƒƒã‚­ãƒ¼ã‚¹ãƒˆãƒ¼ãƒ³</div><div class="li-name">${getLuckyStone(d.seed)}</div></div></div>
    <div class="li-item"><div class="li-icon">ğŸŒ¿</div><div><div class="li-cat">ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ </div><div class="li-name">${getLuckyItem(d.seed)}</div></div></div>
  </div>`;

  const div=document.getElementById('res-fortune');div.innerHTML=html;
  div.scrollIntoView({behavior:'smooth',block:'start'});

  // ãƒ©ãƒƒã‚­ãƒ¼ã‚¹ãƒãƒƒãƒˆå–å¾—ï¼ˆéåŒæœŸï¼‰
  fetchLuckySpots(d.seed, d.fdir);
}

// â”€â”€ Lucky extras â”€â”€
const COLORS=['ã‚´ãƒ¼ãƒ«ãƒ‰','ã‚·ãƒ«ãƒãƒ¼','ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ–ãƒ«ãƒ¼','ãƒ«ãƒ“ãƒ¼ãƒ¬ãƒƒãƒ‰','ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰','ãƒ‘ãƒ¼ãƒ—ãƒ«','ãƒ­ãƒ¼ã‚ºã‚´ãƒ¼ãƒ«ãƒ‰','ã‚³ãƒãƒ«ãƒˆ','ã‚¢ã‚¤ãƒœãƒªãƒ¼','ãƒ†ã‚£ãƒ¼ãƒ«'];
const STONES=['ãƒ«ãƒ“ãƒ¼','ã‚¢ãƒ¡ã‚¸ã‚¹ãƒˆ','ã‚·ãƒˆãƒªãƒ³','ã‚¢ã‚¯ã‚¢ãƒãƒªãƒ³','ãƒ©ãƒ”ã‚¹ãƒ©ã‚ºãƒª','ãƒ­ãƒ¼ã‚ºã‚¯ã‚©ãƒ¼ãƒ„','ã‚¿ã‚¤ã‚¬ãƒ¼ã‚¢ã‚¤','ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰','ã‚¬ãƒ¼ãƒãƒƒãƒˆ','ãƒ ãƒ¼ãƒ³ã‚¹ãƒˆãƒ¼ãƒ³'];
const ITEMS=['æ°´æ™¶çƒ','ç¾½æ ¹ã®ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼','é‡‘è‰²ã®ã‚³ã‚¤ãƒ³','å¤©ç„¶çŸ³','ç™½ã„èŠ±','éˆ´','å¾¡å®ˆã‚Š','å››ã¤è‘‰ã®ã‚¯ãƒ­ãƒ¼ãƒãƒ¼','ç«¹ç‚­','ãƒ‰ãƒ©ã‚¤ãƒ•ãƒ©ãƒ¯ãƒ¼'];
function getLuckyColor(s){return COLORS[Math.floor(sRand(s*89)*COLORS.length)]}
function getLuckyNumbers(s){const r=sRandArr(s*97,3);return r.map(x=>Math.floor(x*44)+1).join(' Â· ')}
function getLuckyStone(s){return STONES[Math.floor(sRand(s*101)*STONES.length)]}
function getLuckyItem(s){return ITEMS[Math.floor(sRand(s*103)*ITEMS.length)]}

// â”€â”€ Render: Gacha â”€â”€
const GACHA_LUCKY={
  ã‚¦ãƒå¨˜:{base:.95,reason:'å¹²æ”¯ãƒ»é…‰ï¼ˆé¦¬ï¼‰Ã—ç‰¡ç¾Šåº§ã®å‹¢ã„ãŒçµ¶å¥½èª¿ã€‚'},
  ãƒ–ãƒ«ã‚¢ã‚«:{base:.92,reason:'å­¦åœ’ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒä»Šæ—¥ã®çŸ¥æ€§é‹ã¨å…±é³´ã€‚'},
  'å´©å£Šï¼šã‚¹ã‚¿ãƒ¼ãƒ¬ã‚¤ãƒ«':{base:.90,reason:'å®‡å®™ã®æµã‚ŒÃ—å…­ç™½é‡‘æ˜Ÿã®é‡‘æ°—ãŒå‰ã€‚'},
  NIKKE:{base:.88,reason:'å‹è² é‹ãŒæœ€é«˜æ½®ã®æ—¥ã€‚æˆ¦é—˜ç³»ã‚²ãƒ¼ãƒ ã«è¿½ã„é¢¨ã€‚'},
  åŸç¥:{base:.87,reason:'é¢¨ãƒ»æ°´ã®å…ƒç´ ãŒä»Šæ—¥ã®æ°—ã®æµã‚Œã¨èª¿å’Œã€‚'},
  é³´æ½®:{base:.85,reason:'éŸ³æ³¢å…±é³´Ã—ä»Šæ—¥ã®æ³¢å‹•ãŒä¸€è‡´ã€‚'},
  'ç„¡æœŸè¿·é€”':{base:.83,reason:'ç ‚æ¼ ã®æ—…äººÃ—è¥¿æ–¹ä½ã®å‰æ°—ãŒå¾ŒæŠ¼ã—ã€‚'},
  ã‚°ãƒ©ãƒ–ãƒ«:{base:.82,reason:'ç©ºã®é¨ç©ºå£«Ã—ä»Šæ—¥ã®é¢¨å‘ããŒæœ€é«˜ã€‚'},
  'Fate/GO':{base:.80,reason:'è‹±éœŠÃ—ç‰¡ç¾Šåº§ã®å‹‡æ°—ã‚¨ãƒãƒ«ã‚®ãƒ¼å…¨é–‹ã€‚'},
  ãƒ—ãƒªã‚³ãƒR:{base:.79,reason:'ãƒ—ãƒªãƒ³ã‚»ã‚¹Ã—ä»Šæ—¥ã®èŠ±é‹ãŒé–‹èŠ±ã€‚'},
  ã‚¢ã‚ºãƒ¼ãƒ«ãƒ¬ãƒ¼ãƒ³:{base:.77,reason:'æµ·è»Ã—å—æ–¹å‰ä½ã§å‹åˆ©ã®äºˆæ„Ÿã€‚'},
  ãƒ˜ãƒ–ãƒãƒ³:{base:.76,reason:'å¤©ä½¿Ã—ä»Šæ—¥ã®æµ„åŒ–ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚'},
  ç™½çŒ«:{base:.75,reason:'å‹‡è€…Ã—æœ¨ã®æ°—ãŒä»Šæ—¥ã®é‹æ°—ã‚’å¾ŒæŠ¼ã—ã€‚'},
  'å´©å£3rd':{base:.74,reason:'ç¥å¥³Ã—å®‡å®™ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå…±é³´ã€‚'},
  ã‚»ãƒ³ãƒ¬ã‚¹ã‚¾ãƒ¼ãƒ³ã‚¼ãƒ­:{base:.79,reason:'éƒ½å¸‚ã®æ°—Ã—ä»Šæ—¥ã®é›»æ°—çš„ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚'},
  ã‚¢ãƒªã‚¹ã‚®ã‚¢:{base:.73,reason:'æ©Ÿæ¢°Ã—é‡‘ã®æ°—ã¨ã®ç›¸æ€§è‰¯å¥½ã€‚'},
  ã‚¹ã‚¯ã‚¹ãƒˆ2:{base:.72,reason:'å°‘å¥³Ã—ä»Šæ—¥ã®ç¸çµã³ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚'},
  ãƒã‚§ãƒ³ã‚¯ãƒ­:{base:.78,reason:'å‹‡è€…ã®æ—…Ã—ä»Šæ—¥ã®æŒ‘æˆ¦é‹ã€‚'},
  é™°é™½å¸«:{base:.80,reason:'æ±æ´‹éœŠåŠ›Ã—å››æŸ±æ¨å‘½ã®ä»Šæ—¥ã®å‰æŸ±ã€‚'},
  ä¿ºã‚¢ãƒ©:{base:.82,reason:'ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—Ã—ä»Šæ—¥ã®æˆé•·ã‚¨ãƒãƒ«ã‚®ãƒ¼æœ€å¤§ã€‚'},
  ãƒ‡ã‚£ã‚¹ã‚¬ã‚¤ã‚¢RPG:{base:.71,reason:'é­”ç•ŒÃ—ä»Šæ—¥ã®ã‚«ã‚ªã‚¹ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå…±é³´ã€‚'},
  ã‚°ãƒ©ã‚¯ãƒ­:{base:.77,reason:'è–é¨å£«Ã—ä»Šæ—¥ã®æ­£ç¾©ã®é‹æ°—ã€‚'},
  ã†ãŸã‚ã‚ŒLF:{base:.75,reason:'å’Œé¢¨éœŠåŠ›Ã—å¹²æ”¯ã®æ°—ã¨ã®èª¿å’Œã€‚'},
  ã¾ãŠã‚Šã‚…ã†:{base:.74,reason:'é­”ç‹Ã—ä»Šæ—¥ã®è¦‡æ°—ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚'},
  ãƒ‰ãƒ«ã‚¦ã‚§ãƒ–:{base:.73,reason:'å…‰Ã—ä»Šæ—¥ã®è¼ãã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚'},
  ã·ã‚ˆã‚¯ã‚¨:{base:.76,reason:'ãƒ‘ã‚ºãƒ«Ã—ä»Šæ—¥ã®å‰µé€ çš„æ€è€ƒã€‚'},
  DQã‚¦ã‚©ãƒ¼ã‚¯:{base:.78,reason:'å‹‡è€…ã®æ­©ã¿Ã—ä»Šæ—¥ã®å†’é™ºé‹ã€‚'},
  PSO2es:{base:.72,reason:'ã‚µã‚¤ã‚¨ãƒ³ã‚¹Ã—é‡‘ã®æ°—ã¨ã®ç›¸æ€§ã€‚'},
  ã“ã®ãƒ•ã‚¡ãƒ³:{base:.74,reason:'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼Ã—ä»Šæ—¥ã®å¤¢é‹ã€‚'},
  ã‘ã‚‚ãƒ•ãƒ¬3:{base:.71,reason:'å‹•ç‰©ã®å‹Ã—ä»Šæ—¥ã®è‡ªç„¶ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚'},
  ãƒ­ã‚¹ã‚¹ãƒˆ:{base:.75,reason:'å¤±ã‚ã‚ŒãŸæ˜ŸÃ—ä»Šæ—¥ã®å†ç™ºè¦‹ã®æ°—ã€‚'},
  'Master Duel':{base:.80,reason:'ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ Ã—ä»Šæ—¥ã®çŸ¥ç•¥é‹æœ€é«˜ã€‚'},
  'PokÃ©mon GO':{base:.77,reason:'ãƒã‚±ãƒ¢ãƒ³Ã—ä»Šæ—¥ã®å†’é™ºãƒ»æ¢ç´¢ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚'},
};
const PULL_ROUTINES=[
  'åŒ—ã‚’å‘ã„ã¦æ·±å‘¼å¸3å› â†’ å·¦æ‰‹ã§ã‚¹ãƒãƒ›ã‚’æŒã¤ â†’ ã€Œå…‰ã‚ˆæ¥ãŸã‚Œã€ã¨å¿ƒã®ä¸­ã§å”±ãˆã‚‹',
  'æ°´ã‚’ä¸€å£é£²ã‚“ã§ã‹ã‚‰ â†’ ç›®ã‚’é–‰ã˜ã¦10ç§’é›†ä¸­ â†’ å³æ‰‹äººå·®ã—æŒ‡ã§å¼•ã',
  'ã‚¹ãƒãƒ›ã‚’é¡ã«å½“ã¦3ç§’ â†’ æ„Ÿè¬ã®æ°—æŒã¡ã‚’è¾¼ã‚ã¦ â†’ ãã£ã¨ç”»é¢ã‚’ã‚¿ãƒƒãƒ—',
  'æ±ã®æ–¹è§’ã‚’å‘ã â†’ æ·±å‘¼å¸2å› â†’ ç¬‘é¡”ã§å¼•ãï¼ˆè¡¨æƒ…ãŒé‹æ°—ã‚’æ±ºã‚ã‚‹ï¼‰',
];

function runGacha(){
  const seed=combinedSeed();const games=Array.from(selGames);
  if(games.length===0){showErr('ã‚²ãƒ¼ãƒ ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');return}
  const ranked=games.map((g,i)=>{
    const info=GACHA_LUCKY[g]||{base:.7,reason:'ä»Šæ—¥ã®é‹æ°—ã¨å…±é³´ã—ã¦ã„ã¾ã™ã€‚'};
    const sc=Math.min(99,Math.max(30,Math.round(info.base*100+(sRand(seed*107+i*113)-0.5)*20)));
    return{game:g,score:sc,reason:info.reason,stars:Math.round(sc/20)};
  }).sort((a,b)=>b.score-a.score);

  const top=ranked.slice(0,5);const worst=ranked[ranked.length-1];
  const routine=PULL_ROUTINES[Math.floor(sRand(seed*127)*PULL_ROUTINES.length)];
  const bestTime=document.getElementById('res-fortune').querySelector('.trange')?.textContent||'14:00-16:00';
  const budget=document.getElementById('budget').value;

  const getPull=(sc,i)=>{
    if(i===0&&sc>=85)return{t:'10é€£æ¨å¥¨',c:'rec'};
    if(sc>=75)return{t:'å˜ç™ºå¯',c:''};
    if(sc>=60)return{t:'æ§˜å­è¦‹',c:''};
    return{t:'è¦‹é€ã‚Šæ¨å¥¨',c:'ng'};
  };

  const d=computeAll();
  const gachaMsg=`${new Date().getMonth()+1}æœˆ${new Date().getDate()}æ—¥ã®ã‚¬ãƒãƒ£ç·åˆé‹ï¼š${d.total>=80?'çµ¶å¥½èª¿ï¼ç©æ¥µçš„ã«å¼•ãã¾ã—ã‚‡ã†':d.total>=70?'è‰¯å¥½ã€‚å‰æ™‚é–“å¸¯ã‚’ç‹™ãˆã°â—':d.total>=60?'æ™®é€šã€‚ç„¡ç†ãªé€£ç¶šå¼•ãã¯æ§ãˆã‚ã«':'ã‚„ã‚„æ§ãˆã‚ã€‚çŸ³ã¯æ¸©å­˜ãŒãŠã™ã™ã‚'}ã€‚äºˆç®—ã€Œ${budget}ã€ã§ã®é‹ç”¨ãŒæœ€é©ã€‚`;

  let html=`
  <div class="c-msg">${gachaMsg}</div>
  <div class="rc c-gacha">
    <div class="ch"><div class="ci">ğŸ°</div><div><div class="ct">æœ¬æ—¥ã®ã‚¬ãƒãƒ£ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div><div class="cs">å¼•ãã¹ãã‚²ãƒ¼ãƒ  TOP${Math.min(5,top.length)}</div></div></div>
    ${top.map((g,i)=>{const pull=getPull(g.score,i);return`
    <div class="gi ${i===0?'t1':i===1?'t2':i===2?'t3':''}">
      <div class="grb ${i===0?'b1':i===1?'b2':i===2?'b3':'bn'}">${g.stars===5?'ğŸ‘‘':g.rank||i+1}</div>
      <div class="ginfo">
        <div class="gname">${i+1}. ${g.game}</div>
        <div class="greason">${g.reason}</div>
        <div style="font-size:.66rem;color:var(--gold);margin-top:2px">ã‚¹ã‚³ã‚¢ï¼š${g.score}pt ${'â˜…'.repeat(g.stars)+'â˜†'.repeat(5-g.stars)}</div>
      </div>
      <div class="gpull ${pull.c}">${pull.t}</div>
    </div>`}).join('')}
  </div>
  <div class="rc" style="background:linear-gradient(135deg,rgba(255,100,100,.08),rgba(7,4,15,.8))">
    <div class="ch"><div class="ci">âš ï¸</div><div><div class="ct" style="color:#FF8080">ä»Šæ—¥ã¯è¦‹é€ã‚Šæ¨å¥¨</div></div></div>
    <div style="font-size:.88rem;font-weight:700;margin-bottom:4px">${worst.game}</div>
    <div style="font-size:.75rem;color:var(--muted)">ä»Šæ—¥ã®é‹æ°—ã¨ã®ç›¸æ€§ãŒæœ€ã‚‚ä½ã„ï¼ˆã‚¹ã‚³ã‚¢ï¼š${worst.score}ptï¼‰</div>
  </div>
  <div class="rc c-div">
    <div class="ch"><div class="ci">âœ¨</div><div><div class="ct">ä»Šæ—¥ã®ã‚¬ãƒãƒ£å‰ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³</div></div></div>
    <div style="font-size:.85rem;line-height:1.9">${routine}</div>
  </div>`;

  const div=document.getElementById('res-gacha');div.innerHTML=html;
  div.scrollIntoView({behavior:'smooth',block:'start'});
}

// â”€â”€ Render: Daily â”€â”€
const ANISONGS=[
  {t:'DREAM SOLISTER',ar:'TRUE',an:'éŸ¿ã‘ï¼ãƒ¦ãƒ¼ãƒ•ã‚©ãƒ‹ã‚¢ãƒ ',r:'éº—å¥ˆã®æƒ…ç†±ãŒä»Šæ—¥ã®ã‚ãªãŸã®é‹æ°—ã‚’å¾ŒæŠ¼ã—ã—ã¾ã™ã€‚',e:'æƒ…ç†±ã¨èª å®Ÿã•ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'oath sign',ar:'LiSA',an:'Fate/Zero',r:'å¥‘ç´„ã®æ™‚ã€‚ä»Šæ—¥ã®é«˜ã„å‹è² é‹ã«ãµã•ã‚ã—ã„ä¸€æ›²ã€‚',e:'æ±ºæ„ã¨è¦šæ‚Ÿã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'Connect',ar:'ClariS',an:'é­”æ³•å°‘å¥³ã¾ã©ã‹â˜†ãƒã‚®ã‚«',r:'çµ†ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå‡ºä¼šã„é‹ã‚’é«˜ã‚ã¾ã™ã€‚',e:'çµ†ã¨å¸Œæœ›ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'ã‚·ãƒ¥ã‚¬ãƒ¼ã‚½ãƒ³ã‚°ã¨ãƒ“ã‚¿ãƒ¼ã‚¹ãƒ†ãƒƒãƒ—',ar:'UNISON SQUARE GARDEN',an:'è¡€ç•Œæˆ¦ç·š',r:'ç–¾èµ°æ„ŸãŒå…­ç™½é‡‘æ˜Ÿã®æ´»åŠ›ã‚’åˆºæ¿€ã™ã‚‹æ—¥ã«æœ€é©ã€‚',e:'èºå‹•ã¨è‡ªç”±ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'ãƒ–ãƒ«ãƒ¼ãƒãƒ¼ãƒ‰',ar:'ã„ãã‚‚ã®ãŒã‹ã‚Š',an:'NARUTO',r:'Bå‹ã®è‡ªç”±é­‚ãŒç¾½ã°ãŸãæ—¥ã«ã´ã£ãŸã‚Šã®ä¸€æ›²ã€‚',e:'è‡ªç”±ã¨é£›ç¿”ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'æ®‹é…·ãªå¤©ä½¿ã®ãƒ†ãƒ¼ã‚¼',ar:'é«˜æ©‹æ´‹å­',an:'ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³',r:'ä½¿å‘½æ„ŸãŒé«˜ã¾ã‚‹æ—¥ã€‚è‡ªåˆ†ã®å¯èƒ½æ€§ã‚’ä¿¡ã˜ã¦ã€‚',e:'ä½¿å‘½ã¨å†ç”Ÿã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'ã‚ˆã†ã“ãã‚¸ãƒ£ãƒ‘ãƒªãƒ‘ãƒ¼ã‚¯ã¸',ar:'ã©ã†ã¶ã¤ãƒ“ã‚¹ã‚±ãƒƒãƒ„Ã—PPP',an:'ã‘ã‚‚ã®ãƒ•ãƒ¬ãƒ³ã‚º',r:'ä»²é–“ã¨ã®çµ†ãŒé‹æ°—ã‚’æŠ¼ã—ä¸Šã’ã‚‹ä»Šæ—¥ã«ã€‚',e:'å‹æƒ…ã¨ç¬‘é¡”ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'crossing field',ar:'LiSA',an:'SAO',r:'æ–°ã—ã„ä¸–ç•Œã¸ã®æ‰‰ãŒé–‹ãäºˆå…†ã€‚é«˜ã„é‹æ°—ã«åˆã‚ã›ã¦ã€‚',e:'æŒ‘æˆ¦ã¨å‰é€²ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'ãƒãƒ¼ãƒˆå½¢ã®è»Œè·¡',ar:'å±±å´ã‚ãŠã„',an:'éŸ¿ã‘ï¼ãƒ¦ãƒ¼ãƒ•ã‚©ãƒ‹ã‚¢ãƒ 3',r:'éº—å¥ˆã®ä¸–ç•Œã€‚ç´”ç²‹ãªå¿ƒãŒæœ€å¤§ã®é–‹é‹ãƒ„ãƒ¼ãƒ«ã€‚',e:'ç´”ç²‹ãªæ„›ã¨èª å®Ÿã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'å»»å»»å¥‡è­š',ar:'Eve',an:'å‘ªè¡“å»»æˆ¦',r:'å¼·ã•ã¨è¦šæ‚Ÿã®æ—¥ã€‚ç‰¡ç¾Šåº§ã®ç«ã‚’ç‡ƒã‚„ã—ã¦ã€‚',e:'å¼·ã•ã¨è¦šæ‚Ÿã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'å…­å…†å¹´ã¨ä¸€å¤œç‰©èª',ar:'é¡éŸ³ãƒªãƒ³',an:'ï¼ˆãƒœã‚«ãƒ­ï¼‰',r:'æƒ³ã„ã‚’è²«ãåŠ›ãŒä»Šæ—¥ã®æ•°ç§˜è¡“ã¨å…±é³´ã€‚',e:'ç´”æ„›ã¨æƒ…ç†±ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'ãƒ’ã‚«ãƒªã‚¢ãƒ¬',ar:'BURNOUT SYNDROMES',an:'ãƒã‚¤ã‚­ãƒ¥ãƒ¼!!',r:'è«¦ã‚ãªã„å¿ƒãŒä»Šæ—¥ã®å‹è² é‹ã‚’æœ€å¤§åŒ–ã€‚',e:'è«¦ã‚ãªã„æƒ…ç†±ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'only my railgun',ar:'fripSide',an:'ã¨ã‚ã‚‹ç§‘å­¦ã®è¶…é›»ç£ç ²',r:'åŠ›å¼·ã„é›»æ°—çš„ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒä»Šæ—¥ã®é‹æ°—ã‚’åº•ä¸Šã’ã€‚',e:'é›»æ°—çš„ãƒ‘ãƒ¯ãƒ¼ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'ç´…è“®è¯',ar:'LiSA',an:'é¬¼æ»…ã®åˆƒ',r:'é¬¼æ»…ã®å¼·ã•Ã—ç‰¡ç¾Šåº§ã®ç«ã®ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãŒå®Œå…¨ä¸€è‡´ã€‚',e:'ç‚ã¨å†ç”Ÿã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
  {t:'ã‚®ãƒ«ãƒ†ã‚£ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£',ar:'Liyuu',an:'ãƒ©ãƒ–ãƒ©ã‚¤ãƒ–ï¼ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¹ã‚¿ãƒ¼!!',r:'è¼ãç¾ã—ã•ãŒä»Šæ—¥ã®å‡ºä¼šã„é‹ã‚’é«˜ã‚ã‚‹ã€‚',e:'è¼ãã¨ç¾ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
];
const FOODS=[
  {n:'ä¸¸äº€è£½éººã®ã¶ã£ã‹ã‘ã†ã©ã‚“',e:'ğŸœ',s:'ãƒ•ãƒ¼ãƒ‰ã‚³ãƒ¼ãƒˆï¼ˆã†ã©ã‚“ï¼‰',r:'ç™½ã„é£ŸæãŒå…­ç™½é‡‘æ˜Ÿã®é‡‘æ°—ã‚’é«˜ã‚ã€åˆå¾Œã®é›†ä¸­åŠ›ã‚’æŒç¶šã•ã›ã¾ã™ã€‚',li:'ã ã—'},
  {n:'å®®å´åœ°é¶ã®ç‚™ã‚Šä¸¼',e:'ğŸ—',s:'å®®å´åœ°é¶å°‚é–€åº—',r:'å¹²æ”¯ãƒ»é…‰ï¼ˆé¶ï¼‰ã‚’é£Ÿã¹ã‚‹ã“ã¨ã§æœ¬æ¥ã®åŠ›ãŒè¦šé†’ã€‚åœ°å…ƒãƒ‘ãƒ¯ãƒ¼ã‚‚åŠ ç®—ã€‚',li:'é¶è‚‰'},
  {n:'ã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹',e:'ğŸ›',s:'ã‚«ãƒ¬ãƒ¼åº—',r:'ç‰¡ç¾Šåº§ãƒ»ç«ã®ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã¨ã‚¹ãƒ‘ã‚¤ã‚¹ãŒå…±é³´ã€‚æƒ…ç†±ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è£œçµ¦ã€‚',li:'ã‚¹ãƒ‘ã‚¤ã‚¹'},
  {n:'ã ã—å·»ãç‰å­å®šé£Ÿ',e:'ğŸ¥š',s:'å®šé£Ÿå±‹ãƒ»å’Œé£Ÿåº—',r:'é»„è‰²ã„é£ŸæãŒæ•°ç§˜4ã®ä»Šæ—¥ã®é‡‘é‹ã‚’å¼•ãå¯„ã›ã¾ã™ã€‚',li:'ç‰å­'},
  {n:'ã„ã¡ã”ã‚¯ãƒ¬ãƒ¼ãƒ—',e:'ğŸ“',s:'ã‚¯ãƒ¬ãƒ¼ãƒ—åº—ãƒ»ã‚«ãƒ•ã‚§',r:'èµ¤ã„ãƒ•ãƒ«ãƒ¼ãƒ„ãŒç‰¡ç¾Šåº§ã®ç«ã‚’è£œçµ¦ã€‚å‡ºä¼šã„é‹ã‚‚UPï¼',li:'ã„ã¡ã”'},
  {n:'é®­ã®ã¡ã‚ƒã‚“ã¡ã‚ƒã‚“ç„¼ãå®šé£Ÿ',e:'ğŸŸ',s:'é­šä»‹ãƒ»å®šé£Ÿå±‹',r:'æ°´ã®æ°—ãŒä¹æ˜Ÿæ°—å­¦ã®ä»Šæ—¥ã®å‰æ°—ã¨èª¿å’Œã€‚å¥åº·é‹ã‚‚ä¸Šæ˜‡ã€‚',li:'é®­'},
  {n:'æ‹…ã€…éºº',e:'ğŸœ',s:'ä¸­è¯æ–™ç†åº—',r:'è¾›ã•ãŒç«ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æ´»æ€§åŒ–ã€‚Bå‹ã®ç›´æ„ŸåŠ›ãŒæœ€å¤§åŒ–ã€‚',li:'ã”ã¾'},
];
const BOOKS=[
  {t:'å½±éŸ¿åŠ›ã®æ­¦å™¨',a:'ãƒ­ãƒãƒ¼ãƒˆãƒ»Bãƒ»ãƒãƒ£ãƒ«ãƒ‡ã‚£ãƒ¼ãƒ‹',g:'å¿ƒç†å­¦ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°',sk:'ç™ºä¿¡åŠ›ãƒ»å‚¾è´åŠ›',r:'è²©å£²8å¹´ã®ãƒ—ãƒ­ã¨ã—ã¦ã€èª¬å¾—ã®å¿ƒç†ã‚’ä½“ç³»çš„ã«å­¦ã¶ä¸€å†Šã€‚é¡§å®¢å¯¾å¿œãŒæ ¼æ®µã«ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã€‚'},
  {t:'FACTFULNESS',a:'ãƒãƒ³ã‚¹ãƒ»ãƒ­ã‚¹ãƒªãƒ³ã‚°',g:'æ•™é¤Šãƒ»ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹',sk:'èª²é¡Œç™ºè¦‹åŠ›ãƒ»æƒ…å ±åˆ†æ',r:'ä¸–ç•Œã‚’æ­£ç¢ºã«è¦‹ã‚‹10ã®æ€è€ƒç¿’æ…£ã€‚çµ±è¨ˆçš„æ€è€ƒã¨èª²é¡Œç™ºè¦‹åŠ›ãŒåŒæ™‚ã«ä¼¸ã³ã¾ã™ã€‚'},
  {t:'å«Œã‚ã‚Œã‚‹å‹‡æ°—',a:'å²¸è¦‹ä¸€éƒãƒ»å¤è³€å²å¥',g:'å¿ƒç†å­¦ãƒ»å“²å­¦',sk:'ã‚¹ãƒˆãƒ¬ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ»è‡ªå·±è¡¨ç¾',r:'ç•°å‹•ã®å¤šã„äººç”Ÿã«ã€ã‚¢ãƒ‰ãƒ©ãƒ¼å¿ƒç†å­¦ãŒæ–°ãŸãªè¦–ç‚¹ã‚’ä¸ãˆã‚‹ã€‚è»¢è·ãƒ»ç‹¬ç«‹ã‚’è€ƒãˆã‚‹ã‚ãªãŸã«ã€‚'},
  {t:'å¤šå‹•åŠ›',a:'å €æ±Ÿè²´æ–‡',g:'ãƒ“ã‚¸ãƒã‚¹ãƒ»è‡ªå·±å•“ç™º',sk:'è¡Œå‹•åŠ›ãƒ»å‰µé€ åŠ›',r:'è»¢è·ãƒ»ç‹¬ç«‹ã‚’è¿·ã†ã‚ãªãŸã¸ã€‚ç‰¡ç¾Šåº§ã®è¡Œå‹•åŠ›ã‚’ã•ã‚‰ã«è§£æ”¾ã™ã‚‹åˆºæ¿€çš„ãªä¸€å†Šã€‚'},
  {t:'ã‚¼ãƒ­ç§’æ€è€ƒ',a:'èµ¤ç¾½é›„äºŒ',g:'æ€è€ƒæ³•ãƒ»ãƒ“ã‚¸ãƒã‚¹',sk:'å®Ÿè¡ŒåŠ›ãƒ»è¨ˆç”»åŠ›',r:'ãƒ¡ãƒ¢æ›¸ã1åˆ†Ã—10æšã§æ€è€ƒãŒæ•´ç†ã•ã‚Œã‚‹ã€‚Appleè²©å£²ã®ãƒ—ãƒ¬ã‚¼ãƒ³åŠ›ã‚‚æ ¼æ®µã«å‘ä¸Šã€‚'},
  {t:'å¤¢ã‚’ã‹ãªãˆã‚‹ã‚¾ã‚¦',a:'æ°´é‡æ•¬ä¹Ÿ',g:'å°èª¬ãƒ»è‡ªå·±å•“ç™º',sk:'ä¸»ä½“æ€§ãƒ»å‘ä¸Šå¿ƒ',r:'é¢ç™½ãã¦å®Ÿè·µçš„ã€‚é…‰å¹´Bå‹ã®è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ä¸€è‡´ã™ã‚‹æˆé•·æ³•å‰‡ãŒè©°ã¾ã£ã¦ã„ã¾ã™ã€‚'},
  {t:'ãƒ–ãƒ«ãƒ¼ãƒ”ãƒªã‚ªãƒ‰',a:'å±±å£ã¤ã°ã•',g:'ãƒãƒ³ã‚¬ãƒ»èŠ¸è¡“',sk:'å‰µé€ åŠ›ãƒ»è‡ªå·±è¡¨ç¾',r:'ã€Œå¥½ããªã“ã¨ã‚’ä»•äº‹ã«ã™ã‚‹è¦šæ‚Ÿã€ã‚’å•ã†ä½œå“ã€‚è»¢è·ãƒ»ç‹¬ç«‹ã®è¿·ã„ã«ç­”ãˆã‚’ä¸ãˆã¦ãã‚Œã‚‹ã€‚'},
];

function runDaily(){
  const seed=combinedSeed();
  const song=ANISONGS[Math.floor(sRand(seed*131)*ANISONGS.length)];
  const food=FOODS[Math.floor(sRand(seed*137)*FOODS.length)];
  const book=BOOKS[Math.floor(sRand(seed*139)*BOOKS.length)];
  const d=computeAll();
  const mantras=['ä»Šæ—¥ã®ç§ã¯ç„¡é™ã®å¯èƒ½æ€§ã‚’æŒã£ã¦ã„ã‚‹','é‹æ°—ã®æ³¢ã«ä¹—ã‚Šã€å…¨ã¦ã‚’å¼•ãå¯„ã›ã‚‹','ã‚ã‚ŠãŒã¨ã†ãŒå¥‡è·¡ã‚’å‘¼ã¶','ç§ã¯ä»Šæ—¥ã‚‚è¼ã„ã¦ã„ã‚‹','ã™ã¹ã¦ã¯æœ€å–„ã®æ–¹å‘ã«å‘ã‹ã£ã¦ã„ã‚‹'];
  const mantra=mantras[Math.floor(sRand(seed*141)*mantras.length)];

  let html=`
  <div style="text-align:center;padding:16px;margin-bottom:14px;background:linear-gradient(135deg,rgba(201,168,76,.08),rgba(139,92,246,.08));border:1px solid rgba(201,168,76,.2);border-radius:14px">
    <div style="font-family:'Zen Old Mincho',serif;font-size:1.05rem;color:var(--gold-light);letter-spacing:.08em;margin-bottom:5px">"${mantra}"</div>
    <div style="font-size:.66rem;color:var(--muted)">ä»Šæ—¥ã®é–‹é‹ãƒãƒ³ãƒˆãƒ©</div>
  </div>

  <div class="rc c-daily">
    <div class="ch"><div class="ci">ğŸµ</div><div><div class="ct">ä»Šæ—¥ã®ã‚¢ãƒ‹ã‚½ãƒ³</div><div class="cs">é‹æ°—ãŒä¸ŠãŒã‚‹ä¸€æ›²</div></div></div>
    <div class="ditem">
      <div class="demoji">ğŸ¶</div>
      <div>
        <div class="dlabel">TODAY'S ANISONG</div>
        <div class="dtitle">ã€Œ${song.t}ã€</div>
        <div class="dsub">${song.ar} / ${song.an}</div>
        <div class="dreason">${song.r}</div>
        <div style="font-size:.66rem;color:var(--gold);margin-top:3px">ã‚¨ãƒãƒ«ã‚®ãƒ¼: ${song.e}</div>
      </div>
    </div>
  </div>

  <div class="rc c-food">
    <div class="ch"><div class="ci">ğŸœ</div><div><div class="ct">ä»Šæ—¥ã®ãƒ©ãƒƒã‚­ãƒ¼ãƒ•ãƒ¼ãƒ‰</div><div class="cs">é–‹é‹é£Ÿæã‚’æ‘‚å–ã—ã‚ˆã†</div></div></div>
    <div class="ditem">
      <div class="demoji">${food.e}</div>
      <div>
        <div class="dlabel">TODAY'S FOOD</div>
        <div class="dtitle">${food.n}</div>
        <div class="dsub">${food.s} | ãƒ©ãƒƒã‚­ãƒ¼é£Ÿæï¼š${food.li}</div>
        <div class="dreason">${food.r}</div>
      </div>
    </div>
  </div>

  <div class="rc" style="background:linear-gradient(135deg,rgba(80,200,120,.1),rgba(7,4,15,.8))">
    <div class="ch"><div class="ci">ğŸ“š</div><div><div class="ct">ä»Šé€±ã®ãŠã™ã™ã‚æœ¬</div><div class="cs">ä¼¸ã³ã‚‹ã‚¹ã‚­ãƒ«ï¼š${book.sk}</div></div></div>
    <div class="ditem">
      <div class="demoji">ğŸ“–</div>
      <div>
        <div class="dlabel">THIS WEEK'S BOOK</div>
        <div class="dtitle">ã€${book.t}ã€</div>
        <div class="dsub">è‘—ï¼š${book.a} | ${book.g}</div>
        <div class="dreason">${book.r}</div>
      </div>
    </div>
  </div>

  <div class="rc c-time">
    <div class="ch"><div class="ci">ğŸ¨</div><div><div class="ct">ä»Šæ—¥ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼ & ãƒŠãƒ³ãƒãƒ¼</div></div></div>
    <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:42px;height:42px;border-radius:50%;background:${getColorHex(seed)};border:2px solid rgba(255,255,255,.2)"></div>
        <div>
          <div style="font-size:.8rem;font-weight:700">${getLuckyColor(seed)}</div>
          <div style="font-size:.66rem;color:var(--muted)">ä»Šæ—¥ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼</div>
        </div>
      </div>
      <div>
        <div style="font-size:.66rem;color:var(--muted);margin-bottom:3px">ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼</div>
        <div style="font-size:1.25rem;font-weight:900;color:var(--gold);letter-spacing:.2em">${getLuckyNumbers(seed)}</div>
      </div>
      <div>
        <div style="font-size:.66rem;color:var(--muted);margin-bottom:3px">ãƒ©ãƒƒã‚­ãƒ¼ã‚¹ãƒˆãƒ¼ãƒ³</div>
        <div style="font-size:.88rem;font-weight:700">${getLuckyStone(seed)}</div>
      </div>
    </div>
  </div>`;

  const div=document.getElementById('res-daily');div.innerHTML=html;
  div.scrollIntoView({behavior:'smooth',block:'start'});
}

const COLOR_HEX={'ã‚´ãƒ¼ãƒ«ãƒ‰':'#D4AF37','ã‚·ãƒ«ãƒãƒ¼':'#C0C0C0','ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ–ãƒ«ãƒ¼':'#4169E1','ãƒ«ãƒ“ãƒ¼ãƒ¬ãƒƒãƒ‰':'#9B111E','ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰':'#50C878','ãƒ‘ãƒ¼ãƒ—ãƒ«':'#8B5CF6','ãƒ­ãƒ¼ã‚ºã‚´ãƒ¼ãƒ«ãƒ‰':'#B76E79','ã‚³ãƒãƒ«ãƒˆ':'#0047AB','ã‚¢ã‚¤ãƒœãƒªãƒ¼':'#FFFFF0','ãƒ†ã‚£ãƒ¼ãƒ«':'#4DC8E0'};
function getColorHex(s){const c=getLuckyColor(s);return COLOR_HEX[c]||'#D4AF37'}

// â”€â”€ Calendar â”€â”€
function getDayLuck(y,m,d){
  const seed=y*10000+m*100+d+userSeed()%999;
  const r=sRand(seed);
  if(r>.92)return 5;if(r>.76)return 4;if(r>.46)return 3;if(r>.26)return 2;return 1;
}
function renderCalendar(){
  const months=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
  document.getElementById('cal-mtitle').textContent=`${calYear}å¹´ ${months[calMonth]}`;
  const grid=document.getElementById('cal-grid');grid.innerHTML='';
  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d=>{const h=document.createElement('div');h.className='cdh';h.textContent=d;grid.appendChild(h)});
  const first=new Date(calYear,calMonth,1).getDay();
  const days=new Date(calYear,calMonth+1,0).getDate();
  const today=new Date();
  for(let i=0;i<first;i++){const e=document.createElement('div');e.className='cd om';grid.appendChild(e)}
  for(let d=1;d<=days;d++){
    const e=document.createElement('div');
    const l=getDayLuck(calYear,calMonth+1,d);
    e.className=`cd l${l}`;
    if(calYear===today.getFullYear()&&calMonth===today.getMonth()&&d===today.getDate())e.classList.add('today');
    e.innerHTML=`<span>${d}</span>${l>=4?'<span class="cd-star">â­</span>':''}`;
    e.onclick=()=>showCalDetail(d,l);grid.appendChild(e);
  }
}
const LUCK_LABELS={5:'â­ æœ€å¼·å‰æ—¥',4:'âœ¦ å‰æ—¥',3:'â— æ™®é€šæ—¥',2:'â–³ ã‚„ã‚„æ³¨æ„',1:'âœ— æ³¨æ„æ—¥'};
const LUCK_TEXTS={5:'å…¨å è¡“ãŒæœ€å¤§ã«æ•´ã†ç‰¹åˆ¥ãªæ—¥ã€‚å¤§åˆ‡ãªæ±ºæ–­ãƒ»ã‚¬ãƒãƒ£10é€£ãƒ»å‘Šç™½ãªã©é‡è¦ãªè¡Œå‹•ã«æœ€é©ã€‚å…­ç™½é‡‘æ˜ŸÃ—ç‰¡ç¾Šåº§ã®ãƒ‘ãƒ¯ãƒ¼ãŒç‚¸è£‚ï¼',4:'é‹æ°—ãŒé«˜ã¾ã‚‹å‰æ—¥ã€‚ç©æ¥µçš„ãªè¡Œå‹•ã‚’ã¨ã‚‹ã¨è‰¯ã„çµæœãŒã€‚ã‚¬ãƒãƒ£å˜ç™ºå¼•ãã‚‚å¥½èª¿ã€‚ä»•äº‹ãƒ»æ‹æ„›ã¨ã‚‚ã«å‰é€²ã‚’ã€‚',3:'ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå¹³è¡¡ã™ã‚‹æ™®é€šã®æ—¥ã€‚ç„¡ç†ã›ãšç€å®Ÿã«é€²ã‚€ã®ãŒå‰ã€‚æ—¥å¸¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’å¤§åˆ‡ã«ã€‚',2:'ã‚„ã‚„é‹æ°—ãŒè½ã¡ç€ãæ—¥ã€‚æ…é‡ã«è¡Œå‹•ã—ã€å¤§ããªæ±ºæ–­ã¯é¿ã‘ã‚‹ã®ãŒç„¡é›£ã€‚ã‚¬ãƒãƒ£ã¯ç¿Œæ—¥ä»¥é™æ¨å¥¨ã€‚',1:'å…­æ›œãƒ»ä¹æ˜Ÿã¨ã‚‚ã«æ§ãˆã‚ãªæ—¥ã€‚ä¼‘é¤Šãƒ»æº–å‚™ãƒ»èª­æ›¸ã«å……ã¦ã¦ç¿Œæ—¥ä»¥é™ã«å‚™ãˆã¾ã—ã‚‡ã†ã€‚'};
function showCalDetail(d,l){
  const det=document.getElementById('cal-detail');
  det.innerHTML=`<div style="color:var(--gold);font-size:.76rem;margin-bottom:6px">${calYear}å¹´${calMonth+1}æœˆ${d}æ—¥ â€” ${LUCK_LABELS[l]}</div><div style="font-size:.78rem;line-height:1.75">${LUCK_TEXTS[l]}</div>`;
  det.classList.add('show');
}
function chgCalMonth(d){calMonth+=d;if(calMonth<0){calMonth=11;calYear--}if(calMonth>11){calMonth=0;calYear++}renderCalendar()}

// â”€â”€ Settings â”€â”€
function saveSettings(){
  document.getElementById('saved-msg').style.display='block';
  setTimeout(()=>document.getElementById('saved-msg').style.display='none',2500);
}


// ============================================
//  RESTAURANT SEARCH ENGINE
//  Powered by OpenStreetMap / Overpass API
//  å®Œå…¨ç„¡æ–™ãƒ»APIã‚­ãƒ¼ä¸è¦ãƒ»å…¨å›½å¯¾å¿œ
// ============================================

// é£²é£Ÿåº—ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ”ãƒ³ã‚°
const REST_CATEGORIES = {
  restaurant: {label:'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', icon:'ğŸ½ï¸', query:'amenity=restaurant'},
  fast_food:  {label:'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰', icon:'ğŸ”', query:'amenity=fast_food'},
  cafe:       {label:'ã‚«ãƒ•ã‚§', icon:'â˜•', query:'amenity=cafe'},
  ramen:      {label:'ãƒ©ãƒ¼ãƒ¡ãƒ³', icon:'ğŸœ', query:'cuisine=ramen'},
  sushi:      {label:'å¯¿å¸', icon:'ğŸ£', query:'cuisine=sushi'},
  izakaya:    {label:'å±…é…’å±‹', icon:'ğŸº', query:'amenity=bar'},
  udon:       {label:'ã†ã©ã‚“ãƒ»è•éº¦', icon:'ğŸœ', query:'cuisine=udon;soba'},
};

// å ã„çš„ãªç†ç”±ç”Ÿæˆï¼ˆã‚¹ã‚³ã‚¢ã¨åˆã‚ã›ã¦ï¼‰
const REST_REASONS_TMPL = [
  'ä»Šæ—¥ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼ã¨ä¸€è‡´ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒæœŸå¾…ã§ãã¾ã™ã€‚é‹æ°—ã¨ã®ç›¸æ€§â—',
  'ä¹æ˜Ÿæ°—å­¦ã®å‰æ–¹ä½ã«ã‚ã‚‹é£²é£Ÿåº—ã€‚è¨ªã‚Œã‚‹ã“ã¨ã§é–‹é‹ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’å–ã‚Šè¾¼ã‚ã¾ã™ã€‚',
  'ã‚¿ãƒ­ãƒƒãƒˆã€Œ${tarot}ã€ã®å°ãã«ã‚ˆã‚Šã€ã“ã®å ´æ‰€ã§ã®é£Ÿäº‹ãŒé‹æ°—ã‚’é«˜ã‚ã¾ã™ã€‚',
  'é¢¨æ°´çš„ã«æ°´ã®æ°—ãŒæµã‚Œã‚‹ã‚¨ãƒªã‚¢ã€‚ç¸çµã³ã¨é‡‘é‹ã«å¥½å½±éŸ¿ã‚’ã‚‚ãŸã‚‰ã—ã¾ã™ã€‚',
  'ç‰¡ç¾Šåº§ã®ç«ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒä»Šæ—¥ã“ã“ã§æœ€ã‚‚å¼·ãå…±é³´ã—ã¦ã„ã¾ã™ã€‚',
  'å…­ç™½é‡‘æ˜Ÿã®å‰æ–¹ä½ã«ä½ç½®ã—ã€é£Ÿäº‹ã§é‡‘æ°—ã‚’è£œå……ã§ãã‚‹å ´æ‰€ã§ã™ã€‚',
  'ä»Šæ—¥ã®æ•°ç§˜${nm}ã¨åº—èˆ—ã®æ³¢å‹•ãŒä¸€è‡´ã€‚é£Ÿäº‹é‹ãŒæœ€é«˜ã®å ´æ‰€ã€‚',
  'ãƒ«ãƒ¼ãƒ³ã€Œ${rune}ã€ãŒç¤ºã™å ´æ‰€ã€‚ã“ã“ã§ã®å‡ºä¼šã„ãŒæ–°ã—ã„ç¸ã‚’ç”Ÿã¿ã¾ã™ã€‚',
];

let nearbyRestaurants = []; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥

async function searchRestaurants() {
  if (!coords) {
    showErr('å…ˆã«ã€Œç¾åœ¨åœ°ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã§GPSå–å¾—ã—ã¦ãã ã•ã„');
    return;
  }

  const resultsDiv = document.getElementById('rest-results');
  const sourceDiv = document.getElementById('rest-source');
  const category = document.getElementById('rest-category').value;
  const radius = parseInt(document.getElementById('rest-radius').value);

  resultsDiv.innerHTML = '<div class="rest-loading">ğŸ” å‘¨è¾ºã®é£²é£Ÿåº—ã‚’æ¤œç´¢ä¸­...</div>';
  sourceDiv.style.display = 'none';

  try {
    // Overpass API ã‚¯ã‚¨ãƒªæ§‹ç¯‰
    const query = buildOverpassQuery(coords.lat, coords.lon, radius, category);
    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

    const response = await fetch(url, { signal: AbortSignal.timeout(15000) });
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();

    const restaurants = parseOverpassResults(data, coords, radius);
    nearbyRestaurants = restaurants;

    if (restaurants.length === 0) {
      resultsDiv.innerHTML = `
        <div class="search-status err">
          ğŸ“ ${radius}mä»¥å†…ã«é£²é£Ÿåº—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>
          <span style="font-size:.68rem">ç¯„å›²ã‚’åºƒã’ã‚‹ã‹ã€ã‚«ãƒ†ã‚´ãƒªã‚’ã€Œã™ã¹ã¦ã€ã§å†æ¤œç´¢ã—ã¦ãã ã•ã„</span>
        </div>`;
      return;
    }

    renderRestaurants(restaurants);
    sourceDiv.style.display = 'block';
    document.getElementById('rest-search-cs').textContent =
      `âœ… ${restaurants.length}ä»¶ã®é£²é£Ÿåº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆ${radius}mä»¥å†…ï¼‰`;

  } catch (err) {
    console.error('Overpass API error:', err);
    resultsDiv.innerHTML = `
      <div class="search-status err">
        âš ï¸ é£²é£Ÿåº—ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>
        <span style="font-size:.68rem">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯APIãŒä¸€æ™‚çš„ã«åˆ©ç”¨ä¸å¯ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</span>
      </div>`;
  }
}

function buildOverpassQuery(lat, lon, radius, category) {
  const around = `(around:${radius},${lat},${lon})`;

  if (category === 'all') {
    return `[out:json][timeout:20];
(
  node["amenity"="restaurant"]${around};
  node["amenity"="fast_food"]${around};
  node["amenity"="cafe"]${around};
  node["amenity"="bar"]${around};
  node["amenity"="food_court"]${around};
  node["cuisine"="ramen"]${around};
  node["cuisine"="sushi"]${around};
  node["cuisine"="udon"]${around};
  node["cuisine"="soba"]${around};
  way["amenity"="restaurant"]${around};
  way["amenity"="fast_food"]${around};
  way["amenity"="cafe"]${around};
);
out body center;`;
  }

  const catInfo = REST_CATEGORIES[category];
  if (!catInfo) return buildOverpassQuery(lat, lon, radius, 'all');

  const [key, val] = catInfo.query.includes(';')
    ? catInfo.query.split('=')
    : catInfo.query.split('=');

  if (catInfo.query.includes(';')) {
    // è¤‡æ•°å€¤ï¼ˆudon;sobaãªã©ï¼‰
    const vals = val.split(';');
    const nodes = vals.map(v => `node["${key}"="${v}"]${around};`).join('\n  ');
    return `[out:json][timeout:20];\n(\n  ${nodes}\n);\nout body center;`;
  }

  return `[out:json][timeout:20];
(
  node["${key}"="${val}"]${around};
  way["${key}"="${val}"]${around};
);
out body center;`;
}

function parseOverpassResults(data, userCoords, radius) {
  const elements = data.elements || [];
  const seen = new Set();
  const results = [];

  for (const el of elements) {
    const tags = el.tags || {};
    const name = tags.name || tags['name:ja'] || tags['name:en'];
    if (!name) continue;
    if (seen.has(name)) continue;
    seen.add(name);

    // åº§æ¨™å–å¾—
    const lat = el.lat || (el.center && el.center.lat);
    const lon = el.lon || (el.center && el.center.lon);
    if (!lat || !lon) continue;

    // è·é›¢è¨ˆç®—
    const dist = calcDist(userCoords.lat, userCoords.lon, lat, lon);
    if (dist > radius) continue;

    // ã‚«ãƒ†ã‚´ãƒªåˆ¤å®š
    const { icon, label } = detectCategory(tags);

    // ä½æ‰€
    const addr = buildAddress(tags);

    // å–¶æ¥­æ™‚é–“
    const hours = tags['opening_hours'] || '';

    results.push({ name, icon, label, addr, dist, lat, lon, tags, hours });
  }

  // è·é›¢é †ã§ã‚½ãƒ¼ãƒˆ
  return results.sort((a, b) => a.dist - b.dist).slice(0, 20);
}

function calcDist(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function detectCategory(tags) {
  const amenity = tags.amenity || '';
  const cuisine = tags.cuisine || '';
  const catMap = [
    { key:'sushi', icon:'ğŸ£', label:'å¯¿å¸' },
    { key:'ramen', icon:'ğŸœ', label:'ãƒ©ãƒ¼ãƒ¡ãƒ³' },
    { key:'udon', icon:'ğŸœ', label:'ã†ã©ã‚“ãƒ»è•éº¦' },
    { key:'soba', icon:'ğŸœ', label:'è•éº¦' },
    { key:'tempura', icon:'ğŸ¤', label:'å¤©ã·ã‚‰' },
    { key:'yakitori', icon:'ğŸ—', label:'ç„¼ãé³¥' },
    { key:'tonkatsu', icon:'ğŸ¥©', label:'ã¨ã‚“ã‹ã¤' },
    { key:'curry', icon:'ğŸ›', label:'ã‚«ãƒ¬ãƒ¼' },
    { key:'italian', icon:'ğŸ', label:'ã‚¤ã‚¿ãƒªã‚¢ãƒ³' },
    { key:'chinese', icon:'ğŸ¥¡', label:'ä¸­è¯æ–™ç†' },
    { key:'french', icon:'ğŸ¥', label:'ãƒ•ãƒ¬ãƒ³ãƒ' },
    { key:'burger', icon:'ğŸ”', label:'ãƒãƒ¼ã‚¬ãƒ¼' },
    { key:'pizza', icon:'ğŸ•', label:'ãƒ”ã‚¶' },
    { key:'steak', icon:'ğŸ¥©', label:'ã‚¹ãƒ†ãƒ¼ã‚­' },
    { key:'seafood', icon:'ğŸ¦', label:'æµ·é®®' },
    { key:'yakiniku', icon:'ğŸ¥©', label:'ç„¼è‚‰' },
  ];
  for (const c of catMap) {
    if (cuisine.includes(c.key)) return { icon: c.icon, label: c.label };
  }
  if (amenity === 'cafe') return { icon: 'â˜•', label: 'ã‚«ãƒ•ã‚§' };
  if (amenity === 'fast_food') return { icon: 'ğŸ”', label: 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰' };
  if (amenity === 'bar') return { icon: 'ğŸº', label: 'å±…é…’å±‹ãƒ»ãƒãƒ¼' };
  if (amenity === 'food_court') return { icon: 'ğŸ½ï¸', label: 'ãƒ•ãƒ¼ãƒ‰ã‚³ãƒ¼ãƒˆ' };
  return { icon: 'ğŸ½ï¸', label: 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³' };
}

function buildAddress(tags) {
  const parts = [];
  if (tags['addr:province'] || tags['addr:state']) parts.push(tags['addr:province'] || tags['addr:state']);
  if (tags['addr:city']) parts.push(tags['addr:city']);
  if (tags['addr:suburb']) parts.push(tags['addr:suburb']);
  if (tags['addr:quarter']) parts.push(tags['addr:quarter']);
  if (tags['addr:street']) parts.push(tags['addr:street']);
  if (tags['addr:housenumber']) parts.push(tags['addr:housenumber']);
  return parts.join(' ') || '';
}

function renderRestaurants(restaurants) {
  const resultsDiv = document.getElementById('rest-results');
  const seed = combinedSeed();
  const d = computeAll();
  const tarotName = d.tarot?.n || 'ã‚¿ãƒ­ãƒƒãƒˆ';
  const nmVal = d.nm || 5;

  const reasons = REST_REASONS_TMPL.map(r =>
    r.replace('${tarot}', tarotName).replace('${nm}', nmVal).replace('${rune}', d.rune?.n || 'ãƒ«ãƒ¼ãƒ³')
  );

  // ä¸Šä½3ä»¶ã¯ç‰¹åˆ¥è¡¨ç¤º
  const top3 = restaurants.slice(0, 3);
  const rest = restaurants.slice(3);

  let html = `<div class="search-status ok">âœ… ${restaurants.length}ä»¶ã®é£²é£Ÿåº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</div>`;

  // TOP3
  top3.forEach((r, i) => {
    const luckScore = Math.min(99, Math.max(60, Math.round(90 - i * 8 + (sRand(seed * 157 + i * 53) - 0.5) * 14)));
    const reason = reasons[(seed + i) % reasons.length];
    const rankLabel = i === 0 ? 'ğŸ¥‡ ç¬¬1ä½ â€” æœ€ã‚‚ãƒ©ãƒƒã‚­ãƒ¼ãªé£²é£Ÿåº—' : i === 1 ? 'ğŸ¥ˆ ç¬¬2ä½' : 'ğŸ¥‰ ç¬¬3ä½';
    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lon}`;
    const distStr = r.dist < 1000 ? `${r.dist}m` : `${(r.dist/1000).toFixed(1)}km`;

    html += `
    <div class="rest-item ${i === 0 ? 'selected' : ''}" onclick="selectRestaurant(this, '${r.name.replace(/'/g,"\'")}')">
      <div class="rest-rank">${rankLabel} <span class="rest-dist">${distStr}</span></div>
      <div class="rest-name">${r.icon} ${r.name}</div>
      <div class="rest-type">
        <span class="rest-badge">${r.label}</span>
        ${r.hours ? `<span class="rest-badge">ğŸ• ${r.hours.slice(0,20)}</span>` : ''}
        <a href="${mapUrl}" target="_blank" class="map-link">ğŸ—ºï¸ åœ°å›³ã§è¦‹ã‚‹</a>
      </div>
      ${r.addr ? `<div class="rest-addr">ğŸ“ ${r.addr}</div>` : ''}
      <div class="rest-reason">âœ¦ ${reason}</div>
      <div style="margin-top:5px;font-size:.7rem">é‹æ°—ã‚¹ã‚³ã‚¢ï¼š<span style="color:var(--gold-light);font-weight:700">${luckScore}pt</span> ${'â˜…'.repeat(Math.round(luckScore/20))}${'â˜†'.repeat(5-Math.round(luckScore/20))}</div>
    </div>`;
  });

  // æ®‹ã‚Šã‚’æŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤º
  if (rest.length > 0) {
    html += `
    <details style="margin-top:8px">
      <summary style="cursor:pointer;font-size:.75rem;color:var(--muted);padding:8px;background:rgba(255,255,255,.03);border-radius:8px;list-style:none">
        â–¼ ãã®ä»–ã®å‘¨è¾ºé£²é£Ÿåº— ${rest.length}ä»¶ã‚’è¡¨ç¤º
      </summary>
      <div style="margin-top:6px">`;

    rest.forEach((r, i) => {
      const mapUrl = `https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lon}`;
      const distStr = r.dist < 1000 ? `${r.dist}m` : `${(r.dist/1000).toFixed(1)}km`;
      html += `
      <div class="rest-item" onclick="selectRestaurant(this, '${r.name.replace(/'/g,"\'")}')">
        <div class="rest-name">${r.icon} ${r.name} <span class="rest-dist">${distStr}</span></div>
        <div class="rest-type"><span class="rest-badge">${r.label}</span>
          <a href="${mapUrl}" target="_blank" class="map-link">ğŸ—ºï¸ åœ°å›³</a></div>
        ${r.addr ? `<div class="rest-addr">ğŸ“ ${r.addr}</div>` : ''}
      </div>`;
    });

    html += `</div></details>`;
  }

  resultsDiv.innerHTML = html;
}

function selectRestaurant(el, name) {
  // é¸æŠçŠ¶æ…‹ãƒˆã‚°ãƒ«
  document.querySelectorAll('.rest-item').forEach(i => i.classList.remove('selected'));
  el.classList.add('selected');
  // é£Ÿäº‹æ¬„ã«åæ˜ 
  const sit = document.getElementById('situation');
  if (sit) sit.value = name + ' ä»˜è¿‘';
}

// GPSå–å¾—æ™‚ã«è‡ªå‹•ã§æ¤œç´¢ãƒãƒ¼ã‚’è¡¨ç¤º
function showRestaurantSearch() {
  document.getElementById('no-gps-msg').style.display = 'none';
  document.getElementById('rest-search-bar').style.display = 'block';
}


// ============================================
//  LUCKY SPOT ENGINE
//  OpenStreetMap / Overpass API å…¨å›½å¯¾å¿œ
// ============================================

// ã‚¹ãƒãƒƒãƒˆã‚«ãƒ†ã‚´ãƒªå®šç¾©
const SPOT_TYPES = [
  { key:'shrine',   icon:'â›©ï¸',  label:'ç¥ç¤¾',     query:'historic=wayside_shrine',  q2:'amenity=place_of_worship religion=shinto' },
  { key:'temple',   icon:'ğŸ¯',  label:'å¯ºé™¢',     query:'historic=temple' },
  { key:'park',     icon:'ğŸŒ¿',  label:'å…¬åœ’',     query:'leisure=park' },
  { key:'garden',   icon:'ğŸŒ¸',  label:'åº­åœ’',     query:'leisure=garden' },
  { key:'castle',   icon:'ğŸ°',  label:'åŸãƒ»å²è·¡',  query:'historic=castle' },
  { key:'museum',   icon:'ğŸ›ï¸',  label:'åšç‰©é¤¨',   query:'tourism=museum' },
  { key:'viewpoint',icon:'ğŸ‘ï¸',  label:'å±•æœ›å°',   query:'tourism=viewpoint' },
  { key:'hotspring',icon:'â™¨ï¸',  label:'æ¸©æ³‰',     query:'amenity=spa' },
  { key:'beach',    icon:'ğŸ–ï¸',  label:'æµ·å²¸ãƒ»ç ‚æµœ', query:'natural=beach' },
  { key:'waterfall',icon:'ğŸ’§',  label:'æ»',       query:'waterway=waterfall' },
];

// å è¡“çš„ãªç†ç”±ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆæ–¹ä½ãƒ»ã‚¿ãƒ­ãƒƒãƒˆãƒ»ä¹æ˜Ÿã¨é€£å‹•ï¼‰
const SPOT_REASON_TEMPLATES = {
  shrine:    [ 'ä¹æ˜Ÿæ°—å­¦ã®{dir}æ–¹ä½ã«ã‚ã‚‹è–åŸŸã€‚å‚æ‹ã™ã‚‹ã“ã¨ã§é‚ªæ°—ãŒæ‰•ã‚ã‚Œã€{star}ã®ãƒ‘ãƒ¯ãƒ¼ãŒå¢—å¹…ã—ã¾ã™ã€‚',
               'å…­ç™½é‡‘æ˜Ÿã®æ°—ã¨ç¥åŸŸã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå…±é³´ã€‚ä»Šæ—¥è¨ªã‚Œã‚‹ã¨ç‰¹åˆ¥ãªã”ç¸ãŒçµã°ã‚Œã¾ã™ã€‚',
               'ã‚¿ãƒ­ãƒƒãƒˆã€Œ{tarot}ã€ãŒç¤ºã™æµ„åŒ–ã®å ´æ‰€ã€‚ä»Šæ—¥ã®é–‹é‹è¡Œå‹•ã¨ã—ã¦æœ€é©ã§ã™ã€‚' ],
  temple:    [ 'ä»é–£ã®é™å¯‚ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒ{dir}æ–¹ä½ã‹ã‚‰å‰æ°—ã‚’å¼•ãè¾¼ã¿ã¾ã™ã€‚åˆæŒã§å¿ƒã‚’æ•´ãˆã¦ã€‚',
               'ç´«å¾®æ–—æ•°ã®{star}ãŒè­·ã‚‹å¯ºé™¢ã€‚ä»Šæ—¥è¨ªã‚Œã‚‹ã“ã¨ã§é‹æ°—ã®åº•ä¸Šã’ãŒæœŸå¾…ã§ãã¾ã™ã€‚' ],
  park:      [ 'è‡ªç„¶ã®æœ¨æ°—ãŒ{dir}æ–¹ä½ã®å‰ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨èª¿å’Œã€‚æ·±å‘¼å¸ã§é‹æ°—ã‚’ãƒªã‚»ãƒƒãƒˆã§ãã¾ã™ã€‚',
               'ã‚¿ãƒ­ãƒƒãƒˆã€Œ{tarot}ã€ãŒç¤ºã™ç”Ÿå‘½åŠ›ã®å ´æ‰€ã€‚ç·‘ã®ä¸­ã§æ°—ã‚’å……é›»ã—ã¾ã—ã‚‡ã†ã€‚',
               'Bå‹ã®è‡ªç”±ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨è‡ªç„¶ã®æ°—ãŒå…±é³´ã€‚æ•£æ­©ã™ã‚‹ã ã‘ã§é‹æ°—UPã€‚' ],
  garden:    [ 'é¢¨æ°´çš„ã«æ°´ã¨ç·‘ãŒèª¿å’Œã™ã‚‹åº­åœ’ã€‚{dir}æ–¹ä½ã«ä½ç½®ã—ã€ä»Šæ—¥ã®é‡‘é‹ã‚’é«˜ã‚ã¾ã™ã€‚' ],
  castle:    [ 'æ­´å²ã®æ°—ãŒå‡ç¸®ã•ã‚ŒãŸå ´æ‰€ã€‚å…­ç™½é‡‘æ˜Ÿã®å‰›æ¯…ãªç²¾ç¥ã¨å…±é³´ã™ã‚‹åŸè·¡ã€‚',
               'ç®—å‘½å­¦çš„ã«ã€Œæ¨©å¨ã¨å®ŸåŠ›ã€ã®å ´æ‰€ã€‚ä»•äº‹é‹ãƒ»å‹è² é‹ã®å¼·åŒ–ã«è¨ªã‚Œã‚‹ã¨å‰ã€‚' ],
  museum:    [ 'çŸ¥è­˜ã¨æ–‡åŒ–ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå……æº€ã€‚æ•°ç§˜{nm}ã®ã€Œæ¢æ±‚å¿ƒã€ã¨å®Œå…¨ä¸€è‡´ã™ã‚‹å ´æ‰€ã€‚' ],
  viewpoint: [ 'é«˜æ‰€ã®æ°—ãŒä¹æ˜Ÿæ°—å­¦ã®{dir}æ–¹ä½ã¨ä¸€è‡´ã€‚é æœ›ã™ã‚‹ã“ã¨ã§è¦–é‡ã¨é‹æ°—ãŒåºƒãŒã‚Šã¾ã™ã€‚' ],
  hotspring: [ 'æ¸©æ³‰ã®åœ°ç†±ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒä½“ã®é‚ªæ°—ã‚’æµ„åŒ–ã€‚ä»Šæ—¥ã®é‹æ°—ãƒªã‚»ãƒƒãƒˆã«æœ€é©ãªå ´æ‰€ã€‚' ],
  beach:     [ 'æµ·ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒ{dir}æ–¹ä½ã®å‰æ°—ã‚’é‹ã‚“ã§ãã‚‹ã€‚æ³¢éŸ³ã§å¿ƒã‚’æµ„åŒ–ã—ã¾ã—ã‚‡ã†ã€‚',
               'æ°´ã®æ°—ãŒç‰¡ç¾Šåº§ã®ç«ã¨èª¿å’Œã—ã€æ‹æ„›é‹ã¨å‰µé€ åŠ›ãŒå¤§å¹…ã«UPã€‚' ],
  waterfall: [ 'æµæ°´ã®æµ„åŒ–ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒæœ€å¼·ã®é–‹é‹ã‚¹ãƒãƒƒãƒˆã€‚ã‚¿ãƒ­ãƒƒãƒˆã€Œ{tarot}ã€ã®æµã‚Œã¨ä¸€è‡´ã€‚' ],
};

const GENERIC_REASONS = [
  '{dir}æ–¹ä½ã«ä½ç½®ã—ã€ä»Šæ—¥ã®ä¹æ˜Ÿæ°—å­¦ã®å‰æ–¹ä½ã¨å®Œå…¨ä¸€è‡´ã€‚',
  'ã‚¿ãƒ­ãƒƒãƒˆã€Œ{tarot}ã€ã®ç¤ºã™é–‹é‹ã®åœ°ã€‚ä»Šæ—¥è¨ªã‚Œã‚‹ã“ã¨ã§é‹æ°—ãŒå¤§ããå‰é€²ã—ã¾ã™ã€‚',
  'å…­ç™½é‡‘æ˜ŸÃ—ç‰¡ç¾Šåº§ã®ãƒ‘ãƒ¯ãƒ¼ãŒæœ€ã‚‚å¼·ãé›†ã¾ã‚‹ã‚¨ãƒªã‚¢ã§ã™ã€‚',
  'æ•°ç§˜{nm}ã®ã€Œå¤‰åŒ–ã€ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨å…±é³´ã™ã‚‹å ´æ‰€ã€‚æ–°ã—ã„å‡ºä¼šã„ã®äºˆå…†ã‚ã‚Šã€‚',
  'ãƒ«ãƒ¼ãƒ³ã€Œ{rune}ã€ãŒç¤ºã™åŠ›ã®æºæ³‰ã€‚ã“ã“ã‚’è¨ªã‚Œã‚‹ã“ã¨ã§æœ¬æ¥ã®åŠ›ãŒè¦šé†’ã—ã¾ã™ã€‚',
];

async function fetchLuckySpots(seed, luckyDir) {
  const resultDiv = document.getElementById('lucky-spot-results');
  const subDiv    = document.getElementById('spot-card-sub');
  if (!resultDiv) return;

  // åº§æ¨™ãªã— â†’ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
  if (!coords) {
    resultDiv.innerHTML = `
      <div class="spot-no-gps">
        ğŸ“ ã€Œç¾åœ¨åœ°ã‚’å–å¾—ã€ã¾ãŸã¯ä½æ‰€ã‚’æ‰‹å‹•å…¥åŠ›ã™ã‚‹ã¨ã€<br>
        <strong style="color:var(--gold-light)">å…¨å›½ã©ã“ã§ã‚‚</strong>å‘¨è¾ºã®é–‹é‹ã‚¹ãƒãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™<br>
        <span style="font-size:.66rem">ç¥ç¤¾ãƒ»å¯ºé™¢ãƒ»å…¬åœ’ãƒ»åŸãƒ»æ¸©æ³‰ãªã©å¯¾å¿œ</span>
      </div>`;
    if (subDiv) subDiv.textContent = 'ä½ç½®æƒ…å ±ã‚’è¨­å®šã™ã‚‹ã¨ã‚¹ãƒãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
    return;
  }

  resultDiv.innerHTML = '<div class="spot-loading">â›©ï¸ å‘¨è¾ºã®é–‹é‹ã‚¹ãƒãƒƒãƒˆã‚’æ¤œç´¢ä¸­...</div>';
  if (subDiv) subDiv.textContent = 'æ¤œç´¢ä¸­...';

  try {
    const radius = 3000; // 3kmä»¥å†…
    const query = buildSpotQuery(coords.lat, coords.lon, radius);
    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
    const resp = await fetch(url, { signal: AbortSignal.timeout(18000) });
    if (!resp.ok) throw new Error('API error ' + resp.status);
    const data = await resp.json();

    const spots = parseSpots(data, coords, radius, seed);

    if (spots.length === 0) {
      // ç¯„å›²ã‚’åºƒã’ã¦å†æ¤œç´¢
      await fetchLuckySpotsWide(seed, luckyDir, resultDiv, subDiv);
      return;
    }

    renderLuckySpots(spots, seed, luckyDir, resultDiv, subDiv);

  } catch(e) {
    console.warn('Spot fetch error:', e);
    resultDiv.innerHTML = `
      <div class="spot-no-gps" style="border-color:rgba(255,100,100,.3)">
        âš ï¸ ã‚¹ãƒãƒƒãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>
        <span style="font-size:.66rem">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ã€Œé‹å‹¢ã‚’å ã†ã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</span>
      </div>`;
    if (subDiv) subDiv.textContent = 'ã‚¹ãƒãƒƒãƒˆå–å¾—å¤±æ•—';
  }
}

async function fetchLuckySpotsWide(seed, luckyDir, resultDiv, subDiv) {
  try {
    const radius = 10000; // 10kmã«æ‹¡å¤§
    const query = buildSpotQuery(coords.lat, coords.lon, radius);
    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
    const resp = await fetch(url, { signal: AbortSignal.timeout(18000) });
    const data = await resp.json();
    const spots = parseSpots(data, coords, radius, seed);

    if (spots.length === 0) {
      resultDiv.innerHTML = `
        <div class="spot-no-gps">
          ğŸ“ 10kmä»¥å†…ã«ã‚¹ãƒãƒƒãƒˆæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>
          <span style="font-size:.66rem">OpenStreetMapã®ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„åœ°åŸŸã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</span>
        </div>`;
      if (subDiv) subDiv.textContent = 'ã‚¹ãƒãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
      return;
    }
    renderLuckySpots(spots, seed, luckyDir, resultDiv, subDiv);
  } catch(e) {
    resultDiv.innerHTML = '<div class="spot-no-gps">âš ï¸ ã‚¹ãƒãƒƒãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
  }
}

function buildSpotQuery(lat, lon, radius) {
  const ar = `(around:${radius},${lat},${lon})`;
  return `[out:json][timeout:25];
(
  node["amenity"="place_of_worship"]["religion"="shinto"]${ar};
  node["amenity"="place_of_worship"]["religion"="buddhist"]${ar};
  node["historic"="castle"]${ar};
  node["historic"="ruins"]${ar};
  node["leisure"="park"]${ar};
  node["leisure"="garden"]${ar};
  node["tourism"="museum"]${ar};
  node["tourism"="viewpoint"]${ar};
  node["tourism"="attraction"]${ar};
  node["amenity"="spa"]${ar};
  node["natural"="beach"]${ar};
  node["natural"="peak"]${ar};
  node["waterway"="waterfall"]${ar};
  way["amenity"="place_of_worship"]["religion"="shinto"]${ar};
  way["amenity"="place_of_worship"]["religion"="buddhist"]${ar};
  way["leisure"="park"]${ar};
  way["historic"="castle"]${ar};
  way["tourism"="museum"]${ar};
  way["natural"="beach"]${ar};
);
out body center;`;
}

function parseSpots(data, userCoords, radius, seed) {
  const elements = data.elements || [];
  const seen = new Set();
  const results = [];

  for (const el of elements) {
    const tags = el.tags || {};
    const name = tags.name || tags['name:ja'] || tags['name:en'];
    if (!name || seen.has(name)) continue;
    seen.add(name);

    const lat = el.lat || (el.center && el.center.lat);
    const lon = el.lon || (el.center && el.center.lon);
    if (!lat || !lon) continue;

    const dist = calcDist(userCoords.lat, userCoords.lon, lat, lon);

    const { icon, label, key } = detectSpotCategory(tags);
    const addr = buildAddress(tags);

    // é–‹é‹ã‚¹ã‚³ã‚¢ï¼ˆè·é›¢ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»ã‚·ãƒ¼ãƒ‰ã§ç®—å‡ºï¼‰
    const distFactor = Math.max(0, 1 - dist / radius);
    const catBonus = { shrine:12, temple:10, castle:8, garden:8, hotspring:7, waterfall:9, beach:8, park:5, museum:4, viewpoint:5 };
    const baseScore = 65 + (catBonus[key] || 5) + distFactor * 20;
    const luckScore = Math.min(99, Math.max(55, Math.round(baseScore + (sRand(seed * 163 + results.length * 59) - 0.5) * 14)));

    results.push({ name, icon, label, key, addr, dist, lat, lon, tags, luckScore });
  }

  return results
    .sort((a, b) => b.luckScore - a.luckScore)
    .slice(0, 15);
}

function detectSpotCategory(tags) {
  const amenity  = tags.amenity  || '';
  const historic = tags.historic || '';
  const leisure  = tags.leisure  || '';
  const tourism  = tags.tourism  || '';
  const natural  = tags.natural  || '';
  const waterway = tags.waterway || '';
  const religion = tags.religion || '';

  if (amenity === 'place_of_worship') {
    if (religion === 'shinto') return { icon:'â›©ï¸', label:'ç¥ç¤¾', key:'shrine' };
    return { icon:'ğŸ¯', label:'å¯ºé™¢', key:'temple' };
  }
  if (historic === 'castle' || historic === 'ruins') return { icon:'ğŸ°', label:'åŸãƒ»å²è·¡', key:'castle' };
  if (leisure === 'park')    return { icon:'ğŸŒ¿', label:'å…¬åœ’', key:'park' };
  if (leisure === 'garden')  return { icon:'ğŸŒ¸', label:'åº­åœ’ãƒ»æ¤ç‰©åœ’', key:'garden' };
  if (tourism === 'museum')  return { icon:'ğŸ›ï¸', label:'åšç‰©é¤¨ãƒ»ç¾è¡“é¤¨', key:'museum' };
  if (tourism === 'viewpoint') return { icon:'ğŸ‘ï¸', label:'å±•æœ›å°ãƒ»å±•æœ›æ‰€', key:'viewpoint' };
  if (tourism === 'attraction') return { icon:'ğŸŒŸ', label:'è¦³å…‰ã‚¹ãƒãƒƒãƒˆ', key:'viewpoint' };
  if (amenity === 'spa')     return { icon:'â™¨ï¸', label:'æ¸©æ³‰ãƒ»ã‚¹ãƒ‘', key:'hotspring' };
  if (natural === 'beach')   return { icon:'ğŸ–ï¸', label:'æµ·å²¸ãƒ»ç ‚æµœ', key:'beach' };
  if (natural === 'peak')    return { icon:'â›°ï¸', label:'å±±ãƒ»å³°', key:'viewpoint' };
  if (waterway === 'waterfall') return { icon:'ğŸ’§', label:'æ»', key:'waterfall' };
  return { icon:'ğŸ“', label:'ã‚¹ãƒãƒƒãƒˆ', key:'park' };
}

function renderLuckySpots(spots, seed, luckyDir, resultDiv, subDiv) {
  // å ã„ãƒ‡ãƒ¼ã‚¿å–å¾—
  const d = computeAll ? computeAll() : {};
  const tarotName = d.tarot ? d.tarot.n : 'ã‚¿ãƒ­ãƒƒãƒˆ';
  const nmVal = d.nm || 5;
  const runeVal = d.rune ? d.rune.n : 'ãƒ«ãƒ¼ãƒ³';
  const dirVal = luckyDir || 'å—';
  const kyuName = document.getElementById('kyusei')?.value || 'å…­ç™½é‡‘æ˜Ÿ';

  function fillReason(tmpl) {
    return tmpl
      .replace('{dir}',   dirVal)
      .replace('{tarot}', tarotName)
      .replace('{nm}',    nmVal)
      .replace('{rune}',  runeVal)
      .replace('{star}',  kyuName);
  }

  function getReason(key, idx) {
    const tmpls = SPOT_REASON_TEMPLATES[key] || GENERIC_REASONS;
    return fillReason(tmpls[(seed + idx) % tmpls.length]);
  }

  const top3  = spots.slice(0, 3);
  const rest  = spots.slice(3);
  const rankIcons = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const rankClass = ['rank1','rank2','rank3'];

  if (subDiv) subDiv.textContent = `${spots.length}ä»¶ã®é–‹é‹ã‚¹ãƒãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

  let html = '';
  top3.forEach((s, i) => {
    const distStr = s.dist < 1000 ? `${s.dist}m` : `${(s.dist/1000).toFixed(1)}km`;
    const mapUrl  = `https://www.google.com/maps/search/?api=1&query=${s.lat},${s.lon}`;
    const reason  = getReason(s.key, i);
    const stars   = 'â˜…'.repeat(Math.round(s.luckScore / 20)) + 'â˜†'.repeat(5 - Math.round(s.luckScore / 20));

    html += `
    <div class="spot-item ${rankClass[i]}">
      <div class="spot-rank-label">
        <span>${rankIcons[i]} ç¬¬${i+1}ä½ é–‹é‹ã‚¹ãƒãƒƒãƒˆ | ${s.label}</span>
        <span class="spot-dist">ğŸ“ ${distStr}</span>
      </div>
      <div class="spot-name">${s.icon} ${s.name}</div>
      <div class="spot-cat">
        <span style="font-size:.62rem;padding:2px 8px;border-radius:10px;background:rgba(139,92,246,.2);border:1px solid rgba(139,92,246,.3);color:#C4B5FD;margin-right:5px">${s.label}</span>
        <a href="${mapUrl}" target="_blank" style="font-size:.68rem;color:var(--cyan);text-decoration:none">ğŸ—ºï¸ åœ°å›³ã§è¦‹ã‚‹</a>
      </div>
      ${s.addr ? `<div class="spot-addr">ğŸ“ ${s.addr}</div>` : ''}
      <div class="spot-reason">âœ¦ ${reason}</div>
      <div class="spot-score">é–‹é‹ã‚¹ã‚³ã‚¢ï¼š<span style="color:var(--gold-light);font-weight:700">${s.luckScore}pt</span> ${stars}</div>
    </div>`;
  });

  if (rest.length > 0) {
    html += `
    <details style="margin-top:8px">
      <summary style="cursor:pointer;font-size:.74rem;color:var(--muted);padding:8px;background:rgba(255,255,255,.03);border-radius:8px;list-style:none">
        â–¼ ãã®ä»–ã®å‘¨è¾ºã‚¹ãƒãƒƒãƒˆ ${rest.length}ä»¶ã‚’è¡¨ç¤º
      </summary>
      <div style="margin-top:6px">`;
    rest.forEach((s, i) => {
      const distStr = s.dist < 1000 ? `${s.dist}m` : `${(s.dist/1000).toFixed(1)}km`;
      const mapUrl  = `https://www.google.com/maps/search/?api=1&query=${s.lat},${s.lon}`;
      html += `
      <div class="spot-item">
        <div class="spot-name">${s.icon} ${s.name} <span class="spot-dist" style="float:right">${distStr}</span></div>
        <div class="spot-cat">
          <span style="font-size:.6rem;padding:2px 7px;border-radius:10px;background:rgba(139,92,246,.15);color:#C4B5FD;margin-right:5px">${s.label}</span>
          <a href="${mapUrl}" target="_blank" style="font-size:.66rem;color:var(--cyan);text-decoration:none">ğŸ—ºï¸ åœ°å›³</a>
        </div>
        ${s.addr ? `<div class="spot-addr">ğŸ“ ${s.addr}</div>` : ''}
      </div>`;
    });
    html += `</div></details>`;
  }

  html += `<div style="font-size:.58rem;color:var(--muted);text-align:right;margin-top:8px">ãƒ‡ãƒ¼ã‚¿å‡ºå…¸: OpenStreetMap contributors (ODbL)</div>`;
  resultDiv.innerHTML = html;
}

// â”€â”€ Init â”€â”€
renderCalendar();
</script>
</body>
</html>
